import{r as u,T as le,f as z,d as ce,u as S,q,ac as J,y as h,Y as k,ad as me,ae as L,af as Y,ag as H,j as t,g as ue,m as pe}from"./index-D_CM1r6M.js";import{I as R,T as be}from"./FormFields-cbkv4QEu.js";import{B as O}from"./Buttons-B9m6-61d.js";import{F as Q,a as Z}from"./FormSection-CqnVxHJP.js";import"./index-CVhLpNpZ.js";import"./iconBase-DSUUJbys.js";import"./index-jLjFIv2f.js";import"./index-DK6bWzrh.js";import"./index-Dskypj5f.js";const ge=(s="create")=>{const[p,b]=u.useState(!1),[m,l]=u.useState(!1),{mrNo:g}=le(),d=z(),I=ce(),N=S(a=>a.ward?.wardsByDepartment||[],q),A=S(a=>a.doctor?.doctors||[],q),x=S(a=>a.department?.departments||[],q),_=S(a=>a.patients),{isLoading:E,isError:P,errorMessage:i}=_||{},w=S(a=>a.ipdPatient),{isLoading:M,isError:j,error:C,isSuccess:f}=w||{},F=S(a=>a.ipdPatient.currentPatient),ee=S(a=>a.ipdPatient.status.search),[v,G]=u.useState(s==="edit"?g:""),[te,$]=u.useState(!1),[o,y]=u.useState({patientId:"",mrNumber:"",referredBy:"",wardType:"",wardNumber:"",admissionDate:new Date().toISOString().split("T")[0],admissionType:"SSP",doctorId:"",departmentId:"",wardId:"",bedNumber:"",admissionFee:"",discount:0,totalFee:0,customWardType:"",paymentStatus:"Unpaid",diagnosis:"",patientName:"",patientContactNo:"",dob:"",cnic:"",age:"",address:"",gender:"",guardianName:"",guardianRelation:"",guardianContact:"",bloodGroup:"",maritalStatus:""}),ae=["A+","A-","B+","B-","AB+","AB-","O+","O-"],re=a=>{if(!a)return"";const r=new Date(a),e=new Date;let n=e.getFullYear()-r.getFullYear();const c=e.getMonth()-r.getMonth();return(c<0||c===0&&e.getDate()<r.getDate())&&n--,n.toString()},se=a=>{const r=a.replace(/\D/g,"");let e=r;return r.length>4&&(e=`${r.substring(0,4)}-${r.substring(4,11)}`),e.substring(0,12)},ie=a=>{const r=a.replace(/\D/g,"");let e=r;return r.length>5&&(e=`${r.substring(0,5)}-${r.substring(5)}`),r.length>12&&(e=`${e.substring(0,13)}-${r.substring(13)}`),e.substring(0,15)},W=u.useCallback(a=>{const r=a.patient,e=a.ward_Information||{},n=x.find(D=>{const B=D.name?.toLowerCase(),X=e.ward_Type?.toLowerCase();return B===X||B?.includes(X)||X?.includes(B)||D.name===e.ward_Type}),c={patientId:r?._id||"",mrNumber:r?.patient_MRNo||"",patientName:r?.patient_Name||"",patientContactNo:r?.patient_ContactNo||"",dob:r?.patient_DateOfBirth?new Date(r.patient_DateOfBirth).toISOString().split("T")[0]:"",cnic:r?.patient_CNIC||"",age:r?.patient_Age?.toString()||"",address:r?.patient_Address||"",gender:r?.patient_Gender||"",guardianName:r?.patient_Guardian?.guardian_Name||"",guardianRelation:r?.patient_Guardian?.guardian_Relation||"",guardianContact:r?.patient_Guardian?.guardian_Contact||"",bloodGroup:r?.patient_BloodType||"",maritalStatus:r?.patient_MaritalStatus||"",admissionDate:a.admission_Details?.admission_Date?new Date(a.admission_Details.admission_Date).toISOString().split("T")[0]:new Date().toISOString().split("T")[0],admissionType:a.admission_Details?.admission_Type||"SSP",doctorId:a.admission_Details?.admitting_Doctor?._id||"",diagnosis:a.admission_Details?.diagnosis||"",departmentId:n?._id||"",wardId:e.ward_Id||"",bedNumber:e.bed_No||"",admissionFee:a.financials?.admission_Fee||"",discount:a.financials?.discount||0,totalFee:a.financials?.total_Charges||0,paymentStatus:a.financials?.payment_Status||"Unpaid"};y(D=>({...D,...c})),n?._id?d(J(n._id)):console.warn("No department found for ward type:",e.ward_Type)},[x,d]),T=u.useCallback(()=>{y({patientId:"",mrNumber:"",referredBy:"",wardType:"",wardNumber:"",admissionDate:new Date().toISOString().split("T")[0],admissionType:"SSP",doctorId:"",departmentId:"",wardId:"",bedNumber:"",admissionFee:"",discount:0,totalFee:0,customWardType:"",paymentStatus:"Unpaid",diagnosis:"",patientName:"",patientContactNo:"",dob:"",cnic:"",age:"",address:"",gender:"",guardianName:"",guardianRelation:"",guardianContact:"",bloodGroup:"",maritalStatus:""}),G("")},[]),U=u.useCallback(()=>{const a=N.find(n=>n._id===o.wardId),r=x.find(n=>n._id===o.departmentId),e={patientId:o.patientId,admission_Details:{admission_Date:new Date(o.admissionDate),diagnosis:o.diagnosis,admission_Type:o.admissionType},ward_Information:{ward_Id:o.wardId,ward_Type:r?.name||"",ward_No:a?.wardNumber||"",bed_No:o.bedNumber,pdCharges:o.pdCharges||0},financials:{admission_Fee:parseFloat(o.admissionFee)||0,discount:parseFloat(o.discount)||0,payment_Status:o.paymentStatus||"Unpaid",total_Charges:(parseFloat(o.admissionFee)||0)-(parseFloat(o.discount)||0)}};return s==="edit"&&o.dischargePatient&&(e.status="Discharged",e.admission_Details.discharge_Date=new Date),o.doctorId&&(e.admission_Details.admitting_Doctor=o.doctorId),e},[o,N,x,s]),V=u.useCallback(()=>{const a={};if(o.patientId||(a.patient="Please search and select a patient first"),o.mrNumber.trim()||(a.mrNumber="MR Number is required"),o.admissionDate||(a.admissionDate="Admission Date is required"),o.departmentId||(a.departmentId="Department is required"),o.wardId||(a.wardId="Ward is required"),o.bedNumber||(a.bedNumber="Bed is required"),(!o.admissionFee||parseFloat(o.admissionFee)<=0)&&(a.admissionFee="Valid Admission Fee is required"),o.paymentStatus||(a.paymentStatus="Payment Status is required"),o.diagnosis.trim()||(a.diagnosis="Diagnosis is required"),s==="create"||s==="edit"&&o.bedNumber!==F?.ward_Information?.bed_No){const r=N.find(e=>e._id===o.wardId);r?r.beds.find(n=>n.bedNumber===o.bedNumber)?.occupied&&(a.bedNumber="Selected bed is occupied"):o.wardId&&(a.wardId="Invalid ward selected")}return a},[o,s,F,N]),ne=u.useCallback(async a=>{if(a.preventDefault(),!v.trim()){h.error("Please enter an MR Number");return}$(!0);try{const r=await d(k(v));if(r&&r.type===k.fulfilled.type){const e=r.payload;if(!e){h.error(`Patient with MR ${v} not found`);return}const n=e?.patient_Guardian||{};y(c=>({...c,patientId:e._id,mrNumber:e?.patient_MRNo||v,patientName:e?.patient_Name||"",patientContactNo:e?.patient_ContactNo||"",dob:e?.patient_DateOfBirth?new Date(e.patient_DateOfBirth).toISOString().split("T")[0]:"",cnic:e?.patient_CNIC||"",age:e?.patient_Age?.toString()||"",address:e?.patient_Address||"",gender:e?.patient_Gender||"",guardianName:n?.guardian_Name||"",guardianRelation:n?.guardian_Relation||"",guardianContact:n?.guardian_Contact||"",bloodGroup:e?.patient_BloodType||"",maritalStatus:e?.patient_MaritalStatus||""})),h.success("Patient data loaded successfully!")}else if(r&&r.type===k.rejected.type){const e=r.payload||r.error?.message||"Unknown error";typeof e=="string"&&e.includes("not found")?h.error(`Patient with MR ${v} not found`):h.error(`Error: ${e}`)}}catch(r){console.error("Search error:",r),h.error("An unexpected error occurred during search")}finally{$(!1)}},[v,d]),de=u.useCallback(a=>{const{name:r,value:e}=a.target;if(r==="departmentId"){y(n=>({...n,departmentId:e,wardId:"",bedNumber:""}));return}if(r==="wardId"){y(n=>({...n,wardId:e,bedNumber:""}));return}switch(r){case"dob":{const n=re(e);y(c=>({...c,dob:e,age:n}));break}case"cnic":{const n=ie(e);y(c=>({...c,cnic:n}));break}case"patientContactNo":case"guardianContact":{const n=se(e);y(c=>({...c,[r]:n}));break}case"admissionFee":{const n=parseFloat(e)||0;y(c=>({...c,admissionFee:n,totalFee:n-(parseFloat(c.discount)||0)}));break}case"discount":{const n=parseFloat(e)||0;y(c=>({...c,discount:n,totalFee:(c.admissionFee||0)-n}));break}default:y(n=>({...n,[r]:e}));break}},[]);u.useEffect(()=>{s==="edit"&&g&&d(me(g))},[s,g,d]),u.useEffect(()=>{s==="edit"&&F&&!p&&(W(F),b(!0))},[s,F,p,W]),u.useEffect(()=>()=>{b(!1)},[s,g]),u.useEffect(()=>{d(L())},[s,d]);const oe=u.useCallback(async a=>{if(a.preventDefault(),!o.patientId){h.error("Please search for a patient first");return}const r=V();if(Object.keys(r).length>0){Object.entries(r).forEach(([,e])=>{h.error(e)});return}l(!0);try{const e=U();if(s==="create"){const n=await d(Y(e));if(Y.rejected.match(n)){const c=n.payload?.message||n.error?.message||"Admission failed";h.error(`Admission error: ${c}`)}}else{const n={mrNo:o.mrNumber,admissionData:e},c=await d(H(n));if(H.rejected.match(c)){const D=c.payload?.message||c.error?.message||(typeof c.payload=="string"?c.payload:"Update failed");h.error(`Update error: ${D}`)}}}catch(e){console.error("Submission error:",e);const n=s==="create"?"Failed to submit form. Please try again.":"Failed to update admission. Please try again.";h.error(n),l(!1)}},[o.patientId,o.mrNumber,V,U,s,d]);return u.useEffect(()=>{if(m){if(f){const a=s==="create"?"Patient admitted successfully!":"Admission updated successfully!";h.success(a),d(L()),s==="create"?(T(),setTimeout(()=>I("/receptionist/ipd/Admitted"),1e3)):(setTimeout(()=>I("/receptionist/ipd/Admitted"),1e3),l(!1))}if(j){const a=s==="create"?`Admission failed: ${C}`:`Update failed: ${C}`;h.error(a),d(L()),l(!1)}}},[m,f,j,C,d,I,s,T]),{mrNo:v,setMrNo:G,formData:o,isSearching:te,bloodGroups:ae,wardsByDepartment:N,doctors:A,departments:x,isPatientLoading:E,isPatientError:P,patientErrorMessage:i,isAdmissionLoading:M,isAdmissionError:j,currentAdmission:F,getAdmissionStatus:ee,handleSearch:ne,handleChange:de,handleSubmit:oe,resetForm:T,mode:s}},he=({mrNo:s,setMrNo:p,handleSearch:b,isLoading:m,isSearching:l})=>{const g=d=>{d.key==="Enter"&&(d.preventDefault(),b(d))};return t.jsxs("div",{className:"mb-8 bg-primary-50 p-4 rounded-lg",children:[t.jsxs("div",{className:"flex items-center mb-4",children:[t.jsx("div",{className:"h-8 w-1 bg-primary-600 mr-3 rounded-full"}),t.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Search Patient"})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx(R,{name:"search",type:"text",value:s,onChange:d=>p(d.target.value),onKeyDown:g,placeholder:"Enter MR Number and press Enter or click Search",icon:"idCard",fullWidth:!0,required:!0,disabled:m||l}),t.jsx(O,{onClick:b,variant:"primary",className:"whitespace-nowrap",disabled:m||l,isLoading:l,children:l?"Searching...":"Search"})]})]})},fe=({formData:s,handleChange:p})=>t.jsxs("div",{className:"mb-8",children:[t.jsxs("div",{className:"flex items-center mb-6",children:[t.jsx("div",{className:"h-10 w-1 bg-primary-600 mr-3 rounded-full"}),t.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Medical Information"})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:t.jsx(be,{name:"diagnosis",label:"Diagnosis",type:"textarea",value:s.diagnosis,onChange:p,placeholder:"Enter Diagnosis",fullWidth:!0,rows:3,required:!0})})]}),ye=({onCancel:s,onSubmit:p,onSaveAndPrint:b,isSubmitting:m,mode:l="create"})=>t.jsxs("div",{className:"flex justify-end gap-4 mt-8 pt-6 border-t border-gray-200",children:[t.jsx(O,{type:"button",onClick:s,variant:"outline",disabled:m,children:"Cancel"}),l==="create"&&b&&t.jsx(O,{type:"button",onClick:b,variant:"secondary",disabled:m,isLoading:m,children:m?"Saving...":"Save & Print"}),t.jsx(O,{type:"submit",onClick:p,variant:"primary",disabled:m,isLoading:m,children:m?l==="create"?"Submitting...":"Updating...":l==="create"?"Submit Admission":"Update Admission"})]}),Ne=({formData:s,handleChange:p,bloodGroups:b,mode:m="create"})=>{const l=m==="edit",g=[{name:"mrNumber",label:"MR Number",type:"text",icon:"idCard",placeholder:"Enter MR Number",required:!0,readOnly:!0},{name:"patientName",label:"Patient Name",type:"text",icon:"user",placeholder:"Enter Patient Name",required:!0,readOnly:!0},{name:"guardianName",label:"Guardian Name",type:"text",icon:"team",placeholder:"Enter Guardian Name",required:!0,readOnly:!l},{name:"guardianRelation",label:"Guardian Relation",type:"select",icon:"team",options:["Father","Mother","Sibling","Spouse","Uncle","Aunt","Grandfather","Grandmother","Other"],readOnly:!l},{name:"dob",label:"Date of Birth",type:"date",icon:"calendar",readOnly:!0},{name:"cnic",label:"CNIC Number",type:"text",icon:"idCard",placeholder:"XXXXX-XXXXXXX-X",readOnly:!0},{name:"age",label:"Age",type:"text",icon:"number",placeholder:"Enter Age",readOnly:!0},{name:"patientContactNo",label:"Patient Contact",type:"tel",icon:"number",placeholder:"03XX-XXXXXXX",required:!0,readOnly:!l},{name:"guardianContact",label:"Guardian Contact",type:"tel",icon:"number",placeholder:"03XX-XXXXXXX",readOnly:!l},{name:"address",label:"Address",type:"text",icon:"home",placeholder:"Enter Full Address",fullWidth:!0,readOnly:!l},{name:"gender",label:"Gender",type:"select",icon:"man",options:["Male","Female"],readOnly:!0},{name:"maritalStatus",label:"Marital Status",type:"select",icon:"ring",options:["Single","Married","Divorced","Widowed"],readOnly:!l},{name:"bloodGroup",label:"Blood Group",type:"select",icon:"heartbeat",options:b,readOnly:!l},{name:"referredBy",label:"Referred By",type:"text",icon:"health",placeholder:"Enter Referral Name (if any)",fullWidth:!0,readOnly:!l}];return t.jsx(Q,{title:"Patient Information",children:t.jsx(Z,{children:g.map(d=>t.jsx(R,{name:d.name,label:d.label,type:d.type,value:s[d.name],onChange:p,icon:d.icon,placeholder:d.placeholder,required:d.required,options:d.options,readOnly:d.readOnly,fullWidth:d.fullWidth},d.name))})})},xe=({formData:s,handleChange:p,mode:b="create"})=>{const m=z(),{departments:l,isLoading:g}=S(i=>i.department),{wardsByDepartment:d,isLoading:I}=S(i=>i.ward),N=d.find(i=>i._id===s.wardId),{doctors:A,isLoading:x}=S(i=>i.doctor);u.useEffect(()=>{m(ue()),m(pe())},[m]),u.useEffect(()=>{s.departmentId&&m(J(s.departmentId))},[s.departmentId,m]);const _=N?.beds?.length>0?N.beds.filter(i=>i?s.bedNumber&&i.bedNumber?.toString()===s.bedNumber?!0:!i.occupied:!1).map(i=>({value:i?.bedNumber?.toString()?.trim()||"",label:i.bedNumber?.toString()===s.bedNumber?`Bed ${i?.bedNumber||""} (Currently Occupied)`:`Bed ${i?.bedNumber||""}`,className:i.bedNumber?.toString()===s.bedNumber?"text-orange-600 font-semibold":"text-green-600"})):[],E=d?.length>0?d.map(i=>({value:i._id,label:`${i.name||"Ward"} (${i.wardNumber||"No Number"}) - ${i.beds?.filter(w=>w&&!w.occupied)?.length||0}/${i.beds?.length||0} available`})):[],P=[{name:"admissionDate",label:"Admission Date",type:"date",icon:"calendar",required:!0},{name:"admissionType",label:"Admission Type",type:"select",icon:"health",options:["SSP","Private","PTCL","State-Life"],required:!0},{name:"doctorId",label:"Doctor",type:"select",icon:"userMd",options:A.map(i=>({value:i._id,label:i.user?.user_Name})),isLoading:x,placeholder:"Select Doctor"},{name:"departmentId",label:"Department",type:"select",icon:"hospital",options:l.map(i=>({value:i._id,label:i.name})),required:!0,placeholder:"Select Department",isLoading:g},{name:"wardId",label:"Ward",type:"select",icon:"home",options:E,required:!0,disabled:!s.departmentId||I,placeholder:s.departmentId?"Select Ward":"Please select department first",isLoading:I},{name:"bedNumber",label:"Bed Number",type:"select",icon:"bed",options:_.length>0?_:[{value:"",key:"no-beds-option",label:s.wardId?"No available beds":"Select ward first",disabled:!0}],required:!0,disabled:!s.wardId,placeholder:s.wardId?_.length>0?"Select Bed":"No available beds":"Please select ward first"},{name:"admissionFee",label:"Admission Fee",type:"number",icon:"dollar",placeholder:"Enter Admission Fee",required:!0},{name:"discount",label:"Discount",type:"number",icon:"discount",placeholder:"Enter Discount",min:"0",max:s.admissionFee||0},{name:"totalFee",label:"Total Fee",type:"text",icon:"dollar",value:s.totalFee?`Rs. ${s.totalFee}`:"Rs. 0",readOnly:!0,className:"bg-gray-50 font-semibold"},{name:"paymentStatus",label:"Payment Status",type:"select",icon:"dollar",options:["Unpaid","Partial","Paid"],value:s.paymentStatus||"Unpaid"}];return t.jsx(Q,{title:"Admission Information",children:t.jsxs(Z,{children:[P.map(i=>t.jsx(R,{name:i.name,label:i.label,type:i.type,value:i.value||s[i.name],onChange:p,icon:i.icon,placeholder:i.placeholder,required:i.required,options:i.options,min:i.min,max:i.max,readOnly:i.readOnly,className:i.className,disabled:i.disabled,isLoading:i.isLoading},i.name)),b==="edit"&&t.jsx("div",{className:"col-span-1 md:col-span-2",children:t.jsxs("div",{className:"flex items-center space-x-3 p-4 bg-yellow-50 rounded-lg border border-yellow-200",children:[t.jsx("input",{type:"checkbox",id:"dischargePatient",name:"dischargePatient",checked:s.dischargePatient||!1,onChange:p,className:"h-5 w-5 text-primary-600 rounded focus:ring-primary-500"}),t.jsx("label",{htmlFor:"dischargePatient",className:"text-lg font-semibold text-yellow-800",children:"Discharge Patient"}),t.jsx("span",{className:"text-sm text-yellow-600 ml-2",children:"(This will free up the bed and mark patient as discharged)"})]})})]})})},K=({message:s})=>t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-600 mb-4"}),t.jsx("div",{className:"text-xl font-semibold text-primary-600",children:s})]})}),De=({mode:s="create"})=>{const p=ge(s);if(!p)return t.jsx("div",{children:"Loading form..."});const{mrNo:b,setMrNo:m,formData:l,isSearching:g,bloodGroups:d,wardsByDepartment:I,doctors:N,departments:A,isPatientLoading:x,isPatientError:_,patientErrorMessage:E,isAdmissionLoading:P,currentAdmission:i,getAdmissionStatus:w,handleSearch:M,handleChange:j,handleSubmit:C,mode:f}=p;if(f==="edit"){if(w==="pending"||w==="idle")return t.jsx(K,{message:"Loading admission details..."});if(w==="succeeded"&&i&&(!l.patientId||!l.mrNumber||!l.departmentId))return t.jsx(K,{message:"Preparing form data..."});if(w==="failed")return t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsx("div",{className:"text-xl font-semibold text-red-500",children:"Error loading admission details"})});if(w==="succeeded"&&!i)return t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsx("div",{className:"text-xl font-semibold text-red-500",children:"No admission data found for this patient"})})}return _?t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsxs("div",{className:"text-xl font-semibold text-red-500",children:["Error: ",E]})}):x||P?t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsx("div",{className:"text-xl font-semibold text-primary-600",children:"Please wait..."})}):t.jsxs("div",{className:"bg-white rounded-xl shadow-md overflow-hidden",children:[t.jsxs("div",{className:"bg-primary-600 p-6 text-white",children:[t.jsx("h1",{className:"text-2xl font-bold",children:f==="create"?"IPD Patient Admission Form":"Edit IPD Admission"}),t.jsx("p",{className:"text-primary-100",children:f==="create"?"Please fill in all required patient details below":"Update the admission details below"})]}),t.jsxs("div",{className:"p-6",children:[f==="create"&&t.jsx(he,{mrNo:b,setMrNo:m,handleSearch:M,isLoading:x,isSearching:g}),f==="edit"&&l.mrNumber&&t.jsx("div",{className:"mb-6 p-4 bg-primary-50 rounded-lg border border-primary-200",children:t.jsxs("div",{className:"flex items-center",children:[t.jsx("div",{className:"h-8 w-1 bg-primary-600 mr-3 rounded-full"}),t.jsxs("div",{children:[t.jsxs("h3",{className:"text-lg font-semibold text-primary-800",children:["Editing Admission for MR: ",l.mrNumber]}),t.jsxs("p",{className:"text-primary-600 text-sm",children:["Patient: ",l.patientName," | Current Status: ",i?.status||"Admitted"]})]})]})}),t.jsxs("form",{onSubmit:C,children:[t.jsx(Ne,{formData:l,handleChange:j,bloodGroups:d,required:!0,mode:f}),t.jsx(xe,{formData:l,handleChange:j,required:!0,mode:f,wardsByDepartment:I,departments:A,doctors:N}),t.jsx(fe,{formData:l,handleChange:j}),t.jsx(ye,{onCancel:()=>window.history.back(),onSubmit:C,onSaveAndPrint:f==="create"?void 0:null,isSubmitting:P,mode:f})]})]})]})};export{De as default};
