import{r as R,e as J,j as e,y as ge,f as fe,d as be,c as Ne,u as ye,bI as je,bJ as ve,bo as Me,bn as ne,bq as we,bK as Ae,bL as Re,bM as De}from"./index-D_CM1r6M.js";import{D as Ce}from"./react-datepicker-DcwYWBG_.js";import{I as U}from"./FormFields-cbkv4QEu.js";import{d as Se}from"./doctors-Bv8ssxVQ.js";import"./floating-ui.dom-DefJBFq2.js";import"./index-DzhyyO-l.js";import"./floating-ui.react-dom-BKXo97rI.js";import"./setYear-CB6OQHaj.js";import"./format-C6WB0tTj.js";import"./isSameMonth-Dw-C10qa.js";import"./parseISO-4cjP3mE1.js";import"./endOfDay-DNsC1XQt.js";import"./index-CVhLpNpZ.js";import"./iconBase-DSUUJbys.js";import"./index-jLjFIv2f.js";import"./index-DK6bWzrh.js";import"./index-Dskypj5f.js";const Pe=({mode:r,totalOfStudies:a,discount:l,setDiscount:M,paidAmount:b,setPaidAmount:D,errors:N,setErrors:S})=>{const[w,P]=R.useState(""),[h,o]=R.useState(""),n=J.useMemo(()=>{const s=Math.max(0,Number(a)||0),v=Math.max(0,Math.floor(Number(l)||0));return Math.max(0,s-v)},[a,l]),f=J.useMemo(()=>{const s=Math.max(0,Number(a)||0),v=Math.min(Math.max(0,Math.floor(Number(l)||0)),s),O=Math.max(0,s-v),q=Math.max(0,Math.floor(Number(b)||0));return Math.max(0,O-q)},[a,l,b]),d=()=>{const s=Math.max(0,Math.floor(Number(w)||0));if(s<=0||s>n){S(v=>({...v,additionalDiscount:`Max Rs. ${n}`}));return}S(v=>({...v,additionalDiscount:""})),M(v=>String(Math.max(0,Math.floor(Number(v)||0))+s)),P("")},j=()=>{const s=Math.max(0,Math.floor(Number(h)||0));if(s<=0||s>f){S(v=>({...v,additionalPaid:`Max Rs. ${f}`}));return}S(v=>({...v,additionalPaid:""})),D(v=>String(Math.max(0,Math.floor(Number(v)||0))+s)),o("")};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-sm font-medium",children:[e.jsx("label",{htmlFor:"paidAmount",className:"block",children:"Paid"}),e.jsx("input",{id:"paidAmount",type:"number",min:0,value:b,onChange:s=>D(s.target.value),placeholder:"Overall Paid (Rs)",className:"mt-1 w-full rounded border border-gray-300 p-2 shadow-sm","data-nav":!0,title:"Overall Paid",disabled:r==="edit",inputMode:"numeric"}),N.paidAmount&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:N.paidAmount})]}),e.jsxs("div",{className:"text-sm font-medium",children:[e.jsx("label",{htmlFor:"discount",className:"block",children:"Discount"}),e.jsx("input",{id:"discount",type:"number",min:0,value:l,onChange:s=>M(s.target.value),placeholder:"Overall Discount (Rs)",className:"mt-1 w-full rounded border border-gray-300 p-2 shadow-sm","data-nav":!0,title:"Overall Discount",disabled:r==="edit",inputMode:"numeric"}),N.discount&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:N.discount})]})]}),r==="edit"&&e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-sm font-medium",children:[e.jsx("label",{htmlFor:"additionalDiscount",className:"block",children:"Additional Discount"}),e.jsxs("div",{className:"mt-1 flex",children:[e.jsx("input",{id:"additionalDiscount",type:"number",min:0,max:n,value:w,onChange:s=>P(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),d())},placeholder:"Enter discount (Rs)",className:"flex-1 rounded-l border border-gray-300 p-2 shadow-sm",inputMode:"numeric"}),e.jsx("button",{type:"button",onClick:d,disabled:!w,className:"rounded-r bg-primary-600 px-3 text-white hover:bg-primary-700 disabled:opacity-50",children:"Apply"})]}),N.additionalDiscount&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:N.additionalDiscount})]}),e.jsxs("div",{className:"text-sm font-medium",children:[e.jsx("label",{htmlFor:"additionalPaid",className:"block",children:"Additional Paid"}),e.jsxs("div",{className:"mt-1 flex",children:[e.jsx("input",{id:"additionalPaid",type:"number",min:0,max:f,value:h,onChange:s=>o(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),j())},placeholder:"Enter amount (Rs)",className:"flex-1 rounded-l border border-gray-300 p-2 shadow-sm",inputMode:"numeric"}),e.jsx("button",{type:"button",onClick:j,disabled:!h,className:"rounded-r bg-primary-600 px-3 text-white hover:bg-primary-700 disabled:opacity-50",children:"Apply"})]}),N.additionalPaid&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:N.additionalPaid})]})]})})]})})},W=r=>{if(!r)return"";const a=new Date,l=new Date(r);a.setHours(0,0,0,0),l.setHours(0,0,0,0);let M=a.getFullYear()-l.getFullYear(),b=a.getMonth()-l.getMonth(),D=a.getDate()-l.getDate();if(D<0){const N=new Date(a.getFullYear(),a.getMonth(),0).getDate();D+=N,b-=1}return b<0&&(b+=12,M-=1),M<0?"":`${M} years ${b} months ${D} days`},Fe=r=>{if(!r)return null;const a=String(r).trim().toLowerCase();if(!isNaN(parseFloat(a))&&!a.includes("month")&&!a.includes("day")&&!a.includes("year")){const w=Math.max(0,parseFloat(a)),P=Math.floor(w),h=Math.round((w-P)*12),o=new Date,n=new Date(o);return n.setFullYear(o.getFullYear()-P),n.setMonth(o.getMonth()-h),n.setDate(o.getDate()),n.setHours(0,0,0,0),n}const l=a.split(/\s+/);let M=0,b=0,D=0;for(let w=0;w<l.length;w++){const P=parseFloat(l[w]);if(isNaN(P))continue;const h=(l[w+1]||"").toLowerCase();h.startsWith("year")?M+=P:h.startsWith("month")?b+=P:h.startsWith("day")&&(D+=P)}if(M===0&&b===0&&D===0){const w=parseFloat(a);isNaN(w)||(M=w)}M=Math.max(0,Math.floor(M)),b=Math.max(0,Math.floor(b)),D=Math.max(0,Math.floor(D));const N=new Date,S=new Date(N);return S.setFullYear(N.getFullYear()-M),S.setMonth(N.getMonth()-b),S.setDate(N.getDate()-D),S.setHours(0,0,0,0),S},Be=({mode:r,patient:a,setPatient:l,dob:M,setDob:b,ageInput:D,setAgeInput:N,useDefaultContact:S,setUseDefaultContact:w,defaultContactNumber:P,prevContactNoRef:h,errors:o,setErrors:n,handleSearchExisting:f,ageTimer:d})=>{const j=c=>{const{name:x,value:m}=c.target;l(F=>({...F,[x]:m}))},s=c=>{if(n(m=>({...m,dob:"",ageManual:""})),!c){b(null),l(m=>({...m,Age:""})),N("");return}if(c>new Date){n(m=>({...m,dob:"DOB cannot be in the future"}));return}b(c);const x=W(c);l(m=>({...m,Age:x})),N(x)},v=c=>{if(!c)return null;const x=new Date,m=c.toLowerCase().split(" ");let F=0,A=0,y=0;if(c.includes(".")){const B=parseFloat(c);isNaN(B)||(B<1?A=Math.round(B*12):(F=Math.floor(B),A=Math.round((B-F)*12)))}else{for(let B=0;B<m.length;B++)m[B]==="year"||m[B]==="years"?F=parseInt(m[B-1])||0:m[B]==="month"||m[B]==="months"?A=parseInt(m[B-1])||0:(m[B]==="day"||m[B]==="days")&&(y=parseInt(m[B-1])||0);!isNaN(c)&&F===0&&A===0&&y===0&&(F=parseInt(c))}const $=new Date(x);return $.setFullYear(x.getFullYear()-F),$.setMonth(x.getMonth()-A),$.setDate(x.getDate()-y),$},O=c=>{const x=c.target.value;N(x),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{if(!x.trim()){n(A=>({...A,ageManual:""})),b(null),l(A=>({...A,Age:""}));return}const m=Fe(x);if(m&&m<=new Date){b(m);const A=W(m);l(y=>({...y,Age:A})),N(A),n(y=>({...y,ageManual:""}));return}const F=v(x);if(F&&F<=new Date){b(F);const A=W(F);l(y=>({...y,Age:A})),N(A),n(y=>({...y,ageManual:""}))}else n(A=>({...A,ageManual:"Invalid age format"}))},800)},q=c=>{w(c),c?(h.current=a.ContactNo||"",l(x=>({...x,ContactNo:P}))):l(x=>({...x,ContactNo:h.current||""}))};return e.jsxs(e.Fragment,{children:[r==="existing"&&e.jsxs("div",{className:"md:col-span-3 flex gap-2 items-end",children:[e.jsxs("div",{className:"","data-nav":!0,children:[e.jsx(U,{name:"MRNo",label:"MR Number",placeholder:"MR-NO",icon:"idCard",value:a.MRNo,onChange:j,onKeyDown:c=>{c.key==="Enter"&&(c.preventDefault(),f())},required:!0,"data-nav":!0}),o.MRNo&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:o.MRNo})]}),e.jsx("button",{type:"button",className:"px-4 h-[42px] bg-primary-700 text-white rounded",onClick:f,title:"Search by MRN",children:"Search"})]}),e.jsx("div",{"data-nav":!0,children:e.jsx(U,{name:"Name",label:"Name",placeholder:"Enter full name",icon:"user",value:a.Name,onChange:j,required:!0})}),r==="new"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{"data-nav":!0,children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Age (auto-calculates DOB) ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",placeholder:"e.g., 20, 0.2, 2 months, 1.5",value:D,onChange:O,className:"border border-gray-300 shadow-sm rounded px-3 py-2 h-[42px] w-full"}),o.ageManual&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:o.ageManual})]}),e.jsxs("div",{"data-nav":!0,children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Date of Birth ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"border rounded border-gray-300 shadow-sm focus-within:ring-2 focus-within:ring-primary-500 focus-within:border-primary-500 h-[42px]",children:e.jsx(Ce,{selected:M,onChange:s,dateFormat:"yyyy-MM-dd",showMonthDropdown:!0,showYearDropdown:!0,dropdownMode:"select",maxDate:new Date,placeholderText:"Select DOB",className:"w-full h-full px-3 py-2 focus:outline-none",onKeyDown:()=>{}})}),o.dob&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:o.dob})]})]}):e.jsx("div",{className:"md:col-span-1","data-nav":!0,children:e.jsx(U,{name:"Age",label:"Age",icon:"calendar",placeholder:"Age auto generated",value:a.Age,onChange:j,readOnly:!0})}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"Gender",className:"block mb-1 font-medium text-gray-700",children:["Gender ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{id:"Gender",name:"Gender",value:a.Gender||"",onChange:j,className:"border h-[42px] p-2 rounded w-full border-gray-200 shadow-sm","data-nav":!0,children:[e.jsx("option",{value:"",children:"Select Gender"}),e.jsx("option",{value:"Male",children:"Male"}),e.jsx("option",{value:"Female",children:"Female"}),e.jsx("option",{value:"Other",children:"Other"})]}),o.Gender&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:o.Gender})]}),e.jsxs("div",{className:"","data-nav":!0,children:[e.jsx(U,{name:"ContactNo",label:"Contact No",placeholder:"Enter Contact No",icon:"phone",value:a.ContactNo,onChange:j,required:!0,disabled:S}),o.ContactNo&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:o.ContactNo})]}),e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx("input",{type:"checkbox",id:"useDefaultContact",checked:S,onChange:c=>q(c.target.checked),className:"mr-2"}),e.jsxs("label",{htmlFor:"useDefaultContact",className:"text-sm text-gray-600",children:["Use default contact number (",P,")"]})]})}),e.jsx("div",{"data-nav":!0,children:e.jsx(U,{name:"CNIC",label:"CNIC",placeholder:"Enter CNIC",icon:"idCard",value:a.CNIC,onChange:j})}),e.jsxs("div",{className:"",children:[e.jsxs("label",{htmlFor:"ReferredBy",className:"block mb-1 font-medium text-gray-700",children:["Referred By ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{id:"ReferredBy",name:"ReferredBy",value:a.ReferredBy||"",onChange:j,className:"border h-[42px] p-2 rounded w-full border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500","data-nav":!0,required:!0,children:[e.jsx("option",{value:"",children:"Select Doctor"}),Se.map((c,x)=>e.jsx("option",{value:c,children:c},x))]}),o.ReferredBy&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:o.ReferredBy})]}),e.jsx("div",{"data-nav":!0,children:e.jsx(U,{name:"Guardian",label:"Guardian Name",placeholder:"Enter full name",icon:"user",value:a.Guardian,onChange:j})})]})},ke=(r="")=>{const a=String(r).match(/\(RS\.?\s*([\d,]+)\)/i);if(a?.[1])return Number(a[1].replace(/,/g,""))||0;const l=String(r).match(/(\d[\d,]*)/);return l?.[1]&&Number(l[1].replace(/,/g,""))||0},Te=({templates:r,studies:a,setStudies:l,errors:M,setErrors:b,mode:D})=>{const N=n=>{const f=String(n||"").trim();if(!f)return;if(a.some(s=>s.templateName===f)){ge.error("This ultrasound is already added!"),b?.(s=>({...s,templateName:""}));return}const d=ke(f),j={templateName:f,totalAmount:d,discount:0,totalPaid:0,remainingAmount:d,referBy:""};l(s=>[...s,j]),b?.(s=>({...s,templateName:""}))},S=n=>{l(f=>f.filter((d,j)=>j!==n))},w=(n,f,d)=>{l(j=>j.map((s,v)=>{if(v!==n)return s;const O={...s};{const q=Math.max(0,Math.floor(Number(d)||0));O.totalAmount=q;const c=Math.min(Math.max(0,Math.floor(Number(O.discount)||0)),q),x=Math.max(0,q-c),m=Math.min(Math.max(0,Math.floor(Number(O.totalPaid)||0)),x);return O.discount=c,O.totalPaid=m,O.remainingAmount=Math.max(0,q-c-m),O}}))},P=n=>n.replace(/\.html$/i,"").replace(/-/g," ").replace(/&/g," & "),h=(n,f)=>n.reduce((d,j)=>d+(Number(j[f])||0),0),o=n=>(Number(n)||0).toLocaleString("en-PK");return e.jsxs("div",{className:"md:col-span-3",children:[e.jsxs("label",{className:"block text-xl font-medium text-gray-700 my-3 border-l-4 border-primary-600 pl-2",children:["Ultrasound Tests ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:"",onChange:n=>N(n.target.value),disabled:D==="edit",className:"border h-[42px] p-2 rounded w-full border-gray-200 shadow-sm mb-3","data-nav":!0,children:[e.jsx("option",{value:"",children:"Select template to addâ€¦"}),(r||[]).map((n,f)=>e.jsx("option",{value:n,children:P(n)},f))]}),a.length>0&&e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg shadow-sm mb-3",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-2 text-left text-sm font-medium text-gray-800 ",children:"Test Name"}),e.jsx("th",{scope:"col",className:"px-4 py-2 text-right text-sm font-medium text-gray-800r",children:"Amount (Rs)"}),D!=="edit"&&e.jsx("th",{scope:"col",className:"px-4 py-2 text-center text-sm font-medium text-gray-800r",children:"Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:a.map((n,f)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-sm  text-gray-900",title:P(n.templateName),children:e.jsx("span",{className:"truncate max-w-[200px] block",children:P(n.templateName)})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right",children:e.jsx("input",{type:"number",min:0,step:1,placeholder:"Price",value:n.totalAmount,onChange:d=>w(f,"totalAmount",d.target.value),onBlur:d=>w(f,"totalAmount",Math.floor(Number(d.target.value)||0)),className:"border border-gray-300 shadow-sm rounded px-2 py-1 text-xs w-24 text-right",title:"Total Amount (Rs)","data-nav":!0})}),D!=="edit"&&e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center",children:e.jsx("button",{type:"button",className:"text-red-600 hover:text-red-800 text-sm ",onClick:()=>S(f),title:"Remove",children:"Remove"})})]},f))})]})}),a.length>0&&e.jsx("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-300 shadow-sm mb-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Financial Summary"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Tests:"}),e.jsx("span",{children:a.length})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Amount:"}),e.jsxs("span",{children:["Rs. ",o(h(a,"totalAmount"))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Final Amount:"}),e.jsxs("span",{className:"text-green-700",children:["Rs."," ",o(h(a,"totalAmount")-h(a,"discount"))]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Total Paid:"}),e.jsxs("span",{children:["Rs. ",o(h(a,"totalPaid"))]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Total Discount:"}),e.jsxs("span",{children:["Rs. ",o(h(a,"discount"))]})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2",children:[e.jsx("span",{children:"Remaining Balance:"}),e.jsxs("span",{className:h(a,"remainingAmount")>0?"text-red-600":"text-green-600",children:["Rs. ",o(h(a,"remainingAmount"))]})]})]})]})}),M?.templateName&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:M.templateName})]})},Ge=({mode:r,setMode:a})=>e.jsxs("div",{className:"flex gap-3 mb-5",children:[e.jsx("button",{type:"button",className:`px-4 py-2 rounded ${r==="existing"?"bg-primary-700 text-white":"bg-gray-200"}`,onClick:()=>a("existing"),disabled:r==="edit",children:"Existing"}),e.jsx("button",{type:"button",className:`px-4 py-2 rounded ${r==="new"?"bg-primary-700 text-white":"bg-gray-200"} `,onClick:()=>a("new"),disabled:r==="edit",children:"New"})]}),Ie=({isLoading:r,handleSubmit:a,navigate:l,submitLabel:M})=>e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 border rounded border-gray-300 shadow-sm",onClick:()=>l(-1),disabled:r,children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 rounded text-white disabled:opacity-60",style:{backgroundColor:"#00897b"},onClick:a,disabled:r,children:r?"Saving...":M})]}),tt=()=>{const r=fe(),a=be(),l=Ne(),{templates:M,isLoading:b,isError:D,error:N,currentReport:S}=ye(t=>t.radiology),[w]=je(),P=w.get("mode"),h=w.get("id"),o=P==="edit"&&!!h,[n,f]=R.useState(o?"edit":"existing");R.useEffect(()=>{f(o?"edit":"existing")},[o]);const[d,j]=R.useState({MRNo:"",Name:"",CNIC:"",Guardian:"",Gender:"",ContactNo:"",ReferredBy:"",Age:""}),[s,v]=R.useState(null),[O,q]=R.useState(""),c=R.useRef(null),[x,m]=R.useState(""),[F,A]=R.useState(""),[y,$]=R.useState([]),[B,Ee]=R.useState(!0),[se,Z]=R.useState(!1),re="051-3311342",oe=R.useRef(""),[H,_]=R.useState({}),z=R.useRef(null),ie=(t,u)=>t.reduce((p,i)=>p+(Number(i[u])||0),0),V=J.useMemo(()=>ie(y,"totalAmount"),[y]),ee=(t,u)=>{const p=t.length;let i=Math.max(0,Math.floor(Number(u)||0));const g=Array(p).fill(0);let C=t.map((I,k)=>({i:k,cap:Math.max(0,Math.floor(I||0))})).filter(I=>I.cap>0);for(;i>0&&C.length>0;){const I=Math.max(1,Math.floor(i/C.length)),k=[];for(const T of C){if(i<=0)break;const E=Math.min(I,T.cap-g[T.i]);E>0&&(g[T.i]+=E,i-=E),g[T.i]<T.cap&&k.push(T)}if(k.length===C.length)break;C=k}let G=0;for(;i>0;){let I=!1;for(let k=0;k<p;k++){const T=(G+k)%p;if(g[T]<Math.max(0,Math.floor(t[T]||0))&&(g[T]+=1,i-=1,G=T+1,I=!0,i===0))break}if(!I)break}return g};R.useEffect(()=>()=>{r(ve())},[r,l.key]),R.useEffect(()=>{r(Me()),r(ne())},[r]),R.useEffect(()=>{o&&h&&r(we(h))},[r,o,h]);const Q=R.useRef(!1);R.useEffect(()=>{if(!S)return;const t=S,u=t.patientMRNO||"",p=t.patientName||t.patient_Name||t.Name||"",i=t.patient_ContactNo||t.ContactNo||t.phone||"",g=t.sex||t.patient_Gender||t.Gender||"",C=t.dob||t.DOB||t.dateOfBirth||t.age||null,G=C?new Date(C):null,I=t.patient_Age||t.ageString||"",k=t?.studies?.[0]?.referBy??t?.referBy??t?.patient_HospitalInformation?.referredBy??t?.ReferredBy??"",T=Array.isArray(t.studies)&&n==="edit"?t.studies.map(Y=>({templateName:Y.templateName,totalAmount:Number(Y.totalAmount||0),discount:Number(Y.discount||0),totalPaid:Number(Y.totalPaid||0),remainingAmount:Number(Y.remainingAmount||0),referBy:Y.referBy||k||"",paymentStatus:Y.paymentStatus||"pending"})):[],E=n==="edit"?Number(t.discount??t.aggTotalDiscount??0):null,K=n==="edit"?Number(t.totalPaid??t.aggTotalPaid??0):null;Q.current=!0,j(Y=>({...Y,MRNo:u||Y.MRNo||"",Name:p||"",ContactNo:i||"",Gender:g||"",ReferredBy:n==="edit"&&k||"",Age:G?W(G):I||Y.Age||""})),v(G),q(G?W(G):I||""),$(T),m(n==="edit"&&Number.isFinite(E)?String(E):""),A(n==="edit"&&Number.isFinite(K)?String(K):""),setTimeout(()=>{Q.current=!1},0)},[S,n]),J.useEffect(()=>{if(Q.current||!y.length||!y.length)return;const t=V,u=Math.min(Math.max(0,Math.floor(Number(x)||0)),Math.max(0,t)),p=Math.max(0,t-u),i=Math.min(Math.max(0,Math.floor(Number(F)||0)),p),g=y.map(E=>Math.max(0,Math.floor(Number(E.totalAmount)||0))),C=ee(g,u),G=y.map((E,K)=>g[K]-C[K]),I=ee(G,i),k=y.map((E,K)=>{const Y=g[K],te=C[K],ae=I[K],pe=Math.max(0,Y-te-ae);return{...E,discount:te,totalPaid:ae,remainingAmount:pe}});y.some((E,K)=>Math.floor(Number(E.discount)||0)!==k[K].discount||Math.floor(Number(E.totalPaid)||0)!==k[K].totalPaid||Math.floor(Number(E.remainingAmount)||0)!==k[K].remainingAmount)&&$(k)},[y.length,V,x,F]);const le=async()=>{_(u=>({...u,MRNo:""}));const t=d.MRNo?.trim();if(!t){_(u=>({...u,MRNo:"MRN is required"}));return}try{await r(Ae(t)).unwrap()}catch(u){_(p=>({...p,MRNo:String(u?.message||"Patient not found")})),j(p=>({...p,Name:"",ContactNo:"",Gender:"",ReferredBy:"",Age:""})),v(null),q("")}},de=()=>{const t={};n==="existing"&&!d.MRNo?.trim()&&(t.MRNo="MRN is required"),d.Name?.trim()||(t.Name="Patient name is required"),d.ContactNo?.trim()||(t.ContactNo="Contact is required"),s||(t.dob="Date of Birth is required"),s&&s>new Date&&(t.dob="DOB cannot be in the future"),d.Gender||(t.Gender="Gender is required"),d.ReferredBy?.trim()||(t.ReferredBy="Referred By is required"),y.length||(t.templateName="Template is required");const u=V,p=Math.floor(Number(x)||0),i=Math.floor(Number(F)||0);return p<0&&(t.discount="Value cannot be negative"),i<0&&(t.paidAmount="Value cannot be negative"),p>u&&(t.discount="Discount cannot exceed Total"),i>u-Math.min(p,u)&&(t.paidAmount="Paid cannot exceed (Total - Discount)"),_(t),Object.keys(t).length===0},L=t=>Math.max(0,Math.floor(Number(t)||0)),ce=(t,u,p)=>{const i=t.reduce((k,T)=>k+L(T.totalAmount),0),g=Math.min(L(u),i),C=Math.min(L(p),Math.max(0,i-g)),G=Math.max(0,i-g-C),I=G===0?"paid":C>0||g>0?"partial":"pending";return{total:i,disc:g,paid:C,remaining:G,status:I}},me=async()=>{if(!de())return;const t=ce(y,x,F),u=y.map(i=>({templateName:i.templateName,totalAmount:L(i.totalAmount),discount:L(i.discount),totalPaid:L(i.totalPaid),remainingAmount:L(i.remainingAmount),paymentStatus:L(i.remainingAmount)===0?"paid":L(i.totalPaid)>0||L(i.discount)>0?"partial":"pending",...o?{}:{referBy:(d.ReferredBy||"").trim()}})),p={patient:{patientMRNO:d.MRNo?.trim()||"",patientName:d.Name?.trim()||"",patient_ContactNo:d.ContactNo?.trim()||"",age:s?new Date(s).toISOString():null,sex:d.Gender||""},studies:u,totalAmount:t.total,discount:t.disc,totalPaid:t.paid,remainingAmount:t.remaining,paymentStatus:t.status,aggTotalAmount:t.total,aggTotalDiscount:t.disc,aggTotalPaid:t.paid,aggRemainingAmount:t.remaining,aggPaymentStatus:t.status,referBy:(d.ReferredBy||"").trim(),cascadeReferBy:!!B};try{o&&h?await r(Re({id:h,reportData:p})).unwrap():await r(De(p)).unwrap(),await r(ne()),ue()}catch(i){_(g=>({...g,submit:i?.message||"Failed to save. Please try again."}))}},ue=()=>{j({MRNo:"",Name:"",CNIC:"",Guardian:"",Gender:"",ContactNo:"",ReferredBy:"",Age:""}),v(null),q(""),m(""),A(""),$([]),Z(!1),_({}),a("/lab/RadiologyPennal")},he=t=>{if(t.key==="Enter"){t.preventDefault(),X(t.shiftKey?-1:1);return}if(t.altKey&&(t.key==="ArrowDown"||t.key==="ArrowRight")){t.preventDefault(),X(1);return}if(t.altKey&&(t.key==="ArrowUp"||t.key==="ArrowLeft")){t.preventDefault(),X(-1);return}},xe=()=>z.current?Array.from(z.current.querySelectorAll("input[data-nav], select[data-nav], textarea[data-nav], [data-nav] input, [data-nav] select, [data-nav] textarea")).filter((u,p,i)=>{const g=window.getComputedStyle(u),C=g.display!=="none"&&g.visibility!=="hidden",G=!u.disabled&&!u.getAttribute("aria-hidden");return C&&G&&i.indexOf(u)===p}):[],X=t=>{const u=xe();if(!u.length)return;const p=u.findIndex(C=>C===document.activeElement||C.contains(document.activeElement)),i=p===-1?0:Math.max(0,Math.min(u.length-1,p+t)),g=u[i];if(g){g.focus();try{g.select&&g.select()}catch{}}};return e.jsx("div",{className:"",children:e.jsxs("div",{className:"max-w-full mx-auto py-6 px-4 bg-white shadow-md",ref:z,onKeyDown:he,children:[e.jsx("h1",{className:"text-3xl bg-primary-600 p-4 text-white font-semibold mb-4",children:"Add Radiology New Record"}),D&&e.jsx("div",{className:"mb-4 rounded border border-red-200 bg-red-50 p-3 text-red-700",children:N||"Something went wrong."}),e.jsx(Ge,{mode:n,setMode:f,disabled:o}),o&&e.jsxs("div",{className:"mb-3 rounded border border-amber-200 bg-amber-50 p-2 text-amber-800 text-sm",children:["Editing existing report (ID: ",h,")"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(Be,{mode:n,patient:d,setPatient:j,dob:s,setDob:v,ageInput:O,setAgeInput:q,useDefaultContact:se,setUseDefaultContact:Z,defaultContactNumber:re,prevContactNoRef:oe,errors:H,setErrors:_,handleSearchExisting:le,ageTimer:c}),e.jsx(Te,{templates:M,studies:y,setStudies:$,errors:H,setErrors:_,mode:n})]}),e.jsx(Pe,{mode:n,totalOfStudies:V,discount:x,setDiscount:m,paidAmount:F,setPaidAmount:A,errors:H,setErrors:_}),H.submit&&e.jsx("div",{className:"mb-4 rounded border border-red-200 bg-red-50 p-3 text-red-700",children:H.submit}),e.jsx(Ie,{isLoading:b,handleSubmit:me,navigate:a,submitLabel:o?"Update Report":"Create Report"})]})})};export{tt as default};
