import{f as dt,d as ut,u as L,r as u,bO as mt,bP as ft,j as d,bQ as pt,y,bR as ht}from"./index-D_CM1r6M.js";import{a as gt,B as w}from"./Buttons-B9m6-61d.js";import{F as U}from"./FormSection-CqnVxHJP.js";import{R as Nt}from"./server.browser-DuO4EFVg.js";import{P as V}from"./PrintPatientTest-kJOah_91.js";import{P as yt,T as xt}from"./TestInfo-oPe2ns1S.js";import"./logo1-Cp_MkaTU.js";import"./FormFields-cbkv4QEu.js";import"./index-CVhLpNpZ.js";import"./iconBase-DSUUJbys.js";import"./index-jLjFIv2f.js";import"./index-DK6bWzrh.js";import"./index-Dskypj5f.js";import"./doctors-Bv8ssxVQ.js";const Ot=()=>{const x=dt(),Q=ut(),{patient:bt,loading:Ct,error:wt}=L(e=>e.patientTest),T=L(e=>e.patientTest.tests),[R,B]=u.useState(!1),[P,k]=u.useState("existing"),[l,N]=u.useState({id:"",MRNo:"",CNIC:"",Name:"",ContactNo:"",Gender:"",Age:"",ReferredBy:"",Guardian:""}),[G,A]=u.useState(""),[f,p]=u.useState([]),[Rt,F]=u.useState(null),[W,O]=u.useState(null),[E,S]=u.useState(null),[I,j]=u.useState(!1),[D]=u.useState("051-3311342"),[$,H]=u.useState(0),q=u.useRef(null),i=e=>{const t=parseInt(e,10);return Number.isNaN(t)?0:Math.max(0,t)},h=e=>e.map(t=>{const n=i(t.amount),o=Math.min(i(t.discount),n),r=n-o,c=Math.min(i(t.paid),r),g=Math.max(0,r-c);return{...t,amount:n,discount:o,finalAmount:r,paid:c,remaining:g}});u.useEffect(()=>(x(mt()),()=>x(ft())),[x]),u.useEffect(()=>{I?N(e=>({...e,ContactNo:D})):l.ContactNo===D&&N(e=>({...e,ContactNo:""}))},[I,D]);const K=()=>{N({id:"",MRNo:"",CNIC:"",Name:"",ContactNo:"",Gender:"",Age:"",ReferredBy:"",Guardian:""}),A(""),p([]),F(null),O(null),S(null),j(!1),k("existing"),H(e=>e+1)},z=e=>{if(!e)return"";const t=new Date,n=new Date(e);let o=t.getFullYear()-n.getFullYear(),r=t.getMonth()-n.getMonth(),c=t.getDate()-n.getDate();return c<0&&(r--,c+=new Date(t.getFullYear(),t.getMonth(),0).getDate()),r<0&&(o--,r+=12),`${o} years ${r} months ${c} days`},J=e=>{O(e),N(t=>({...t,Age:z(e)}))},X=e=>{const{name:t,value:n}=e.target;t==="CNIC"&&n.length>13||t==="ContactNo"&&n.length>15||N({...l,[t]:n})},Z=async()=>{const e=l.MRNo?.trim();if(!e){alert("Please enter MR No.");return}try{const t=await x(pt(e)).unwrap();if(!t){alert("Patient not found.");return}(!t.contactNo||t.contactNo.trim()==="")&&j(!0),N({MRNo:t.mrno||"",CNIC:t.cnic||"",Name:t.name||"",ContactNo:t.contactNo||"",Gender:t.gender||"",Age:t.age||z(t.DateOfBirth)||"",ReferredBy:t.referredBy||"",Guardian:t.gaurdian||""})}catch(t){console.error("❌ Patient not found:",t),alert(t.payload?.message||"Patient not found. Please check MR No.")}},tt=e=>{const t=e??G;if(!t)return;const n=T?.find(c=>c._id===t);if(!n)return;const o=new Date().toISOString().split("T")[0],r=i(n.testPrice);p(c=>h([...c,{testId:n._id,testName:n.testName,testCode:n.testCode,quantity:c.length+1,sampleDate:o,reportDate:o,amount:r,discount:0,finalAmount:r,paid:0,remaining:r,notes:""}])),A("")},et=(e,t,n)=>{const o=[...f];o[e][t]=["amount","discount","paid"].includes(t)?i(n):n,p(h(o))},nt=e=>{const n=f.filter((o,r)=>r!==e).map((o,r)=>({...o,quantity:r+1}));p(h(n))},b=f.reduce((e,t)=>e+i(t.amount),0),v=f.reduce((e,t)=>e+Math.min(i(t.discount),i(t.amount)),0),C=b-v,M=f.reduce((e,t)=>e+i(t.paid),0),at=Math.max(0,C-M),ot=e=>{const t=i(e);if(t>b){y.error("Total discount cannot exceed total amount");return}const n=[...f];if(t===b){const s=n.map(a=>({...a,discount:i(a.amount)}));p(h(s));return}const o=n.map(s=>{const a=i(s.amount);if(a===0)return{...s,discount:0};const m=t*(a/b),_=Math.floor(m);return{...s,discount:_}});let r=o.reduce((s,a)=>s+a.discount,0),c=t-r;const g=[...n.keys()].sort((s,a)=>i(n[a].amount)-i(n[s].amount));for(let s of g){const a=i(n[s].amount);for(;c>0&&o[s].discount<a;)o[s].discount+=1,c-=1;if(c===0)break}p(h(o))},st=e=>{const t=i(e);if(t>C){y.error("Total paid cannot exceed total final amount");return}const n=[...f];if(t===C){const s=n.map(a=>{const m=i(a.amount)-i(a.discount);return{...a,paid:m}});p(h(s));return}const o=n.map(s=>{const a=i(s.amount)-i(s.discount);if(a===0)return{...s,paid:0};const m=t*(a/C),_=Math.floor(m);return{...s,paid:_}});let r=o.reduce((s,a)=>s+a.paid,0),c=t-r;const g=[...n.keys()].sort((s,a)=>i(n[a].amount)-i(n[a].discount)-(i(n[s].amount)-i(n[s].discount)));for(let s of g){const a=i(n[s].amount)-i(n[s].discount);for(;c>0&&o[s].paid<a;)o[s].paid+=1,c-=1;if(c===0)break}p(h(o))},rt=e=>{const t=Nt.renderToString(d.jsx(V,{formData:e})),n=window.open("","_blank");n.document.write(t),n.document.close(),n.print()},Y=async(e=!1)=>{if(f.length===0){y.error("Please add at least one test");return}if(!l.Name?.trim()){y.error("Patient name is required");return}const t=h(f),n=t.reduce((a,m)=>a+m.amount,0),o=t.reduce((a,m)=>a+m.discount,0),r=n-o,c=t.reduce((a,m)=>a+m.paid,0),g=Math.max(0,r-c),s={patient_MRNo:l.MRNo,patient_CNIC:l.CNIC,patient_Name:l.Name,patient_Guardian:l.Guardian,patient_ContactNo:l.ContactNo,patient_Gender:l.Gender,patient_Age:l.Age,referredBy:l.ReferredBy,isExternalPatient:P==="new",selectedTests:t.map(a=>({test:a.testId,testPrice:a.amount,discountAmount:a.discount,advanceAmount:a.paid,remainingAmount:a.remaining,sampleDate:a.sampleDate,reportDate:a.reportDate,notes:a.notes||""})),totalAmount:n,advanceAmount:c,remainingAmount:g,totalPaid:c,performedBy:""};try{B(!0);const a=await x(ht(s)).unwrap();if(y.success("Data saved successfully!"),!a)throw new Error("Submission failed - no data returned");if(F(a),e){const m={tokenNumber:a.tokenNumber,patient:{MRNo:a.patient?.mrNo||l.MRNo,Name:l.Name,CNIC:l.CNIC,ContactNo:l.ContactNo,Gender:l.Gender,Age:l.Age,ReferredBy:l.ReferredBy,Guardian:l.Guardian},tests:t,totalAmount:n,totalDiscount:o,totalFinalAmount:r,totalPaid:c,remaining:g,sampleDate:t[0]?.sampleDate,reportDate:t[0]?.reportDate,referredBy:l.ReferredBy};rt(m)}K()}catch(a){console.error("❌ Submission error:",a),y.error(`Submission failed: ${a.message}`)}finally{B(!1)}},it=async e=>{e.preventDefault(),await Y(!1),Q("/lab/all-patients")},ct=async e=>{e.preventDefault(),await Y(!0)},lt=e=>{const t=q.current;if(!t||e.target.closest(".react-select__control")||e.target.closest(".react-select__menu")||e.target.closest(".react-select__input"))return;const n=Array.from(t.querySelectorAll("input, select, textarea")).filter(r=>r.type!=="hidden"&&!r.disabled&&!r.closest(".react-select__control")&&!r.closest(".react-select__menu")),o=n.indexOf(e.target);o!==-1&&(["Enter","ArrowDown","ArrowRight"].includes(e.key)&&(e.preventDefault(),o<n.length-1&&n[o+1].focus()),["ArrowUp","ArrowLeft"].includes(e.key)&&(e.preventDefault(),o>0&&n[o-1].focus()))};return d.jsxs("form",{onSubmit:it,ref:q,onKeyDown:lt,className:"p-6 bg-white rounded shadow-md space-y-10",children:[d.jsx("div",{className:"w-screen -ml-6 bg-teal-600 py-6 text-white text-3xl font-bold shadow",children:d.jsx("h1",{className:"ml-4",children:"Add Patient New Test"})}),d.jsx(U,{title:"Patient Information",bgColor:"bg-primary-700 text-white",children:d.jsx(yt,{mode:P,patient:l,dob:W,handlePatientChange:X,handleSearch:Z,handleDobChange:J,setMode:k,useDefaultContact:I,setUseDefaultContact:j,defaultContactNumber:D},`pinfo-${$}`)}),d.jsx(U,{title:"Test Information",bgColor:"bg-primary-700 text-white",children:d.jsx(xt,{testList:T,selectedTestId:G,setSelectedTestId:A,testRows:f,handleTestAdd:tt,handleTestRowChange:et,handleRemoveRow:nt,totalAmount:b,totalDiscount:v,totalFinalAmount:C,totalPaid:M,overallRemaining:at,applyOverallPaid:st,applyOverallDiscount:ot,paidBoxValue:M,discountBoxValue:v,mode:P},`tinfo-${$}`)}),d.jsxs(gt,{className:"justify-end",children:[d.jsx(w,{type:"button",variant:"secondary",onClick:K,children:"Cancel"}),d.jsx(w,{type:"submit",variant:"primary",disabled:R,children:R?"Submitting...":"Submit"}),d.jsx(w,{type:"button",variant:"primary",disabled:R,onClick:ct,children:R?"Processing...":"Submit & Print"})]}),E&&d.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:d.jsxs("div",{className:"bg-white p-6 rounded-lg max-w-4xl max-h-screen overflow-auto",children:[d.jsxs("div",{className:"flex justify-between items-center mb-4",children:[d.jsx("h2",{className:"text-xl font-bold",children:"Print Preview"}),d.jsxs("div",{className:"space-x-2",children:[d.jsx(w,{variant:"primary",onClick:()=>{window.print(),S(null)},children:"Print Now"}),d.jsx(w,{variant:"secondary",onClick:()=>S(null),children:"Close"})]})]}),d.jsx(V,{formData:E})]})})]})};export{Ot as default};
