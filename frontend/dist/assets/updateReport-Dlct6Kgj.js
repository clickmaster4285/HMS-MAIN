import{T as Y,f as J,u as xe,r as d,bU as pe,ca as Z,j as e,d as ge}from"./index-D_CM1r6M.js";import{R as he}from"./server.browser-DuO4EFVg.js";import{A as fe,j as L,x as be,p as M,e as V,B as ye,n as ee,m as je,h as te,z as ve,i as Ne,f as U,d as W}from"./index-C4dsM683.js";import{i as we,f as K,g as Ce,P as ke}from"./PrintTestReport-BSxuLDc0.js";import{L as Se,E as X}from"./ErrorState-BYtf-fu6.js";import"./iconBase-DSUUJbys.js";const Te=()=>{const{id:s}=Y(),f=J(),{patientTestById:a,status:R,error:k}=xe(r=>r.patientTest),[C,b]=d.useState({results:{},status:"completed",notes:"",performedBy:""}),[u,j]=d.useState({}),[v,c]=d.useState(0),[N,D]=d.useState({}),x=a?.patientTest?.selectedTests||[],m=a?.testDefinitions||[],S=a?.patientTest?{patientName:a.patientTest.patient_Detail?.patient_Name,gender:a.patientTest.patient_Detail?.patient_Gender,age:a.patientTest.patient_Detail?.patient_Age,mrNumber:a.patientTest.patient_Detail?.patient_MRNo,cnic:a.patientTest.patient_Detail?.patient_CNIC,contactNo:a.patientTest.patient_Detail?.patient_ContactNo,testDate:a.patientTest.createdAt,referredBy:a.patientTest.patient_Detail?.referredBy,paymentStatus:a.patientTest.paymentStatus,finalAmount:a.patientTest.finalAmount,tokenNumber:a.patientTest.tokenNumber}:null;d.useEffect(()=>{s&&f(pe(s))},[f,s]),d.useEffect(()=>{if(x.length>0&&m.length>0){const r={},w={};x.forEach(y=>{const i=m.find(t=>t._id===y.test)?.fields||[];r[y.test]=i.map(t=>({fieldName:t.name,value:t.value||"",notes:t.note||"",unit:t.unit||"",normalRange:t.normalRange||null,fieldId:t._id,inputType:t.inputType||"text",options:t.options||[],customOptions:t.options||[]})),w[y.test]=P(y.statusHistory)}),b(y=>({...y,results:r})),j(w)}},[x,m]);const P=d.useCallback(r=>!r||r.length===0?"registered":[...r].sort((y,T)=>new Date(T.changedAt)-new Date(y.changedAt))[0].status,[]),g=d.useCallback((r,w,y,T)=>{b(i=>{const t={...i.results},o=[...t[r]||[]];return o[w]={...o[w],[y]:T},{...i,results:{...t,[r]:o}}}),y==="value"&&T.trim()!==""&&j(i=>({...i,[r]:"completed"}))},[]),A=d.useCallback((r,w,y)=>{b(T=>{const i={...T.results},t=[...i[r]||[]];return t[w]={...t[w],options:y,customOptions:y},{...T,results:{...i,[r]:t}}})},[]),n=d.useCallback(async r=>{const w=m.find(i=>i._id===r);if(!w||!Array.isArray(w.fields)){console.warn("Skipping update: no fields for test",r);return}const T={results:(C?.results?.[r]||[]).filter(i=>i?.fieldName?.trim()?.length).map(i=>({fieldName:i.fieldName,value:i.value,notes:i.notes,testId:r,inputType:i.inputType,options:i.options})),status:u[r]??"pending",notes:C.notes??"",performedBy:C.performedBy??""};try{return await f(Z({patientTestId:s,testId:r,updateData:T})).unwrap(),D(i=>({...i,[r]:T.status})),!0}catch(i){throw console.error("Failed to save test:",i),i}},[C,m,u,f,s]);return{formData:C,setFormData:b,statusByTest:u,setStatusByTest:j,activeTestIndex:v,setActiveTestIndex:c,localStatuses:N,selectedTests:x,testDefinitions:m,patientData:S,patientTestById:a,status:R,error:k,handleFieldChange:g,handleOptionChange:A,saveCurrentTest:n,getCurrentStatus:P}},Re=({field:s,fieldIndex:f,testId:a,value:R,onChange:k,onOptionChange:C,patientData:b,inputRef:u,onKeyDown:j})=>{const[v,c]=d.useState(!1),[N,D]=d.useState(""),x=we(R,s.normalRange,b),m=s.inputType==="dropdown",S=s.customOptions||s.options||[],P=()=>{if(N.trim()&&!S.includes(N.trim())){const n=[...S,N.trim()];C(a,f,n),D("")}},g=n=>{const r=S.filter(w=>w!==n);C(a,f,r)},A=n=>{n.key==="Enter"&&P()};return e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-gray-200 hover:border-primary-300 transition-colors duration-200",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-4 items-start",children:[e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Field Name"}),e.jsx("input",{type:"text",value:s.fieldName,className:"w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-50 text-gray-600 cursor-not-allowed",disabled:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Result ",m&&e.jsx("button",{type:"button",onClick:()=>c(!v),className:"ml-1 text-primary-600 hover:text-primary-800 transition-colors",title:"Edit dropdown options",children:e.jsx(fe,{size:14})})]}),m?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("select",{value:R,onChange:n=>k(a,f,"value",n.target.value),ref:u,onKeyDown:j,className:"w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200",children:[e.jsx("option",{value:"",children:"Select an option"}),S.map((n,r)=>e.jsx("option",{value:n,children:n},r))]}),v&&e.jsxs("div",{className:"bg-primary-50 border border-primary-200 rounded-lg p-3 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-primary-800",children:"Edit Options"}),e.jsx("button",{onClick:()=>c(!1),className:"text-primary-600 hover:text-primary-800",children:e.jsx(L,{size:16})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:N,onChange:n=>D(n.target.value),onKeyPress:A,placeholder:"Add new option",className:"flex-1 text-sm border border-primary-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-primary-500"}),e.jsx("button",{onClick:P,className:"bg-primary-600 text-white p-1 rounded hover:bg-primary-700 transition-colors",disabled:!N.trim(),children:e.jsx(be,{size:14})})]}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:S.map((n,r)=>e.jsxs("div",{className:"flex items-center justify-between bg-white px-2 py-1 rounded text-sm",children:[e.jsx("span",{children:n}),e.jsx("button",{onClick:()=>g(n),className:"text-red-500 hover:text-red-700 transition-colors",children:e.jsx(L,{size:14})})]},r))})]})]})]}):e.jsx("input",{type:s.inputType==="number"?"number":"text",value:R,onChange:n=>k(a,f,"value",n.target.value),ref:u,onKeyDown:j,enterKeyHint:"next",className:"w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200",placeholder:`Enter ${s.inputType==="number"?"numeric":"text"} value`})]}),e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("input",{type:"text",value:s.unit,className:"w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-50 text-gray-600 cursor-not-allowed",disabled:!0})]}),e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-2 flex items-center",children:"Normal Range"}),e.jsxs("div",{className:"text-sm text-gray-600 bg-gray-50 rounded-lg px-3 py-2 border min-h-[42px]",title:K(s.normalRange,b),children:[e.jsx("div",{className:"font-medium text-xs text-primary-600",children:Ce(s.normalRange,b)}),K(s.normalRange,b).split(" | ")[0]]})]}),e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsx("div",{className:`text-sm font-medium rounded-lg px-3 py-2 border ${x===!0?"bg-green-100 text-green-800 border-green-200":x===!1?"bg-red-100 text-red-800 border-red-200":"bg-gray-100 text-gray-600 border-gray-200"}`,children:x===!0?e.jsxs("span",{className:"flex items-center",children:[e.jsx(M,{className:"mr-1"})," Normal"]}):x===!1?e.jsxs("span",{className:"flex items-center",children:[e.jsx(L,{className:"mr-1"})," Abnormal"]}):e.jsx("span",{children:"Not evaluated"})})]})]}),s.normalRange&&Object.keys(s.normalRange||{}).length>1&&e.jsxs("div",{className:"mt-3 p-2 bg-primary-50 rounded text-xs text-primary-700 border border-primary-200",children:[e.jsx("div",{className:"font-medium",children:"Available ranges:"}),K(s.normalRange,b)]})]})},De=({selectedTests:s,testDefinitions:f,activeTestIndex:a,setActiveTestIndex:R,formData:k,handleFieldChange:C,handleOptionChange:b,handleFormDataChange:u,patientData:j,statusByTest:v,setStatusByTest:c,saveCurrentTest:N,getCurrentStatus:D})=>{const x=s?.[a],m=x?.test,S=k?.results?.[m]||[],P=s.length,g=d.useRef([]),A=d.useRef(null),n=d.useRef(null),r=d.useRef(null),w=t=>{switch(t?.toLowerCase()){case"completed":return"bg-green-100 text-green-800 border-green-300";case"verified":return"bg-blue-100 text-blue-800 border-blue-300";case"processing":return"bg-yellow-100 text-yellow-800 border-yellow-300";case"registered":return"bg-gray-100 text-gray-800 border-gray-300";case"cancelled":return"bg-red-100 text-red-800 border-red-300";case"draft":return"bg-purple-100 text-purple-800 border-purple-300";default:return"bg-gray-100 text-gray-800 border-gray-300"}},y=(t,o)=>{if(t.key==="Enter"){t.preventDefault();const E=g.current?.[o+1];E&&typeof E.focus=="function"?E.focus():A.current&&A.current.focus()}},T=(t,o)=>{t.key==="Enter"&&(t.preventDefault(),o?.current&&typeof o.current.focus=="function"&&o.current.focus())},i=(t,o)=>{t.key==="Enter"&&!t.shiftKey&&t.preventDefault()};return d.useEffect(()=>{g.current=Array(S.length);const t=setTimeout(()=>{const o=g.current?.[0];o&&typeof o.focus=="function"&&o.focus()},0);return()=>clearTimeout(t)},[m,S.length]),x?e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:x?.testDetails?.testName||"Test Results"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium border ${w(v[x?.test]||D(x?.statusHistory))}`,children:v[x?.test]||D(x?.statusHistory)})]}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Test ",a+1," of ",P]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600 mb-2",children:[e.jsx("span",{children:"Progress"}),e.jsxs("span",{children:[Math.round((a+1)/P*100),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-primary-600 h-2 rounded-full transition-all duration-500 ease-out",style:{width:`${(a+1)/P*100}%`}})})]}),e.jsx("div",{className:"space-y-4 mb-8",children:S.map((t,o)=>e.jsx(Re,{field:t,fieldIndex:o,testId:m,value:t.value,onChange:C,onOptionChange:b,patientData:j,inputRef:E=>g.current[o]=E,onKeyDown:E=>y(E,o)},o))}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-6 bg-gray-50 rounded-xl border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Performed By"}),e.jsx("input",{type:"text",value:k.performedBy||"",onChange:t=>u("performedBy",t.target.value),ref:A,onKeyDown:t=>T(t,n),className:"w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200",placeholder:"Enter technician name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Report Status"}),e.jsxs("select",{value:v?.[m]||"registered",onChange:t=>c(o=>({...o,[m]:t.target.value})),ref:n,onKeyDown:t=>T(t,r),className:"w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200",children:[e.jsx("option",{value:"registered",children:"Registered"}),e.jsx("option",{value:"processing",children:"Processing"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"verified",children:"Verified"}),e.jsx("option",{value:"cancelled",children:"Cancelled"}),e.jsx("option",{value:"draft",children:"Draft"})]})]}),e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Overall Test Report"}),e.jsx("textarea",{rows:3,value:k.notes||"",onChange:t=>u("notes",t.target.value),ref:r,onKeyDown:t=>i(t),className:"w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200",placeholder:"Overall interpretation / impression (Shift+Enter for newline)"})]})]})]}):e.jsx("div",{className:"p-6 text-center text-gray-500",children:"No test selected"})},Pe=({patientData:s,selectedTests:f,testDefinitions:a,activeTestIndex:R,setActiveTestIndex:k,localStatuses:C={}})=>{const b=c=>{switch((c||"pending").toLowerCase()){case"registered":return"bg-primary-100 text-primary-800";case"in_progress":case"processing":return"bg-yellow-100 text-yellow-800";case"completed":return"bg-green-100 text-green-800";case"verified":return"bg-purple-100 text-purple-800";case"cancelled":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},u=c=>(c||"pending").replace("_"," ").toUpperCase(),j=f?.[R],v=j&&(C[j.test]??j?.testDetails?.reportStatus)||"pending";return e.jsxs("div",{className:"p-8 bg-primary-50",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(V,{className:"w-6 h-6 text-primary-600 mr-3"}),e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Patient & Test Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-md",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-4 flex items-center",children:[e.jsx(V,{className:"w-4 h-4 mr-2 text-primary-600"}),"Patient Details"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Name"}),e.jsx("p",{className:"font-medium text-gray-800",children:s.patientName})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Gender"}),e.jsx("p",{className:"font-medium text-gray-800",children:s.gender})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Age"}),e.jsx("p",{className:"font-medium text-gray-800",children:s.age})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-500",children:"CNIC"}),e.jsx("p",{className:"font-medium text-gray-800",children:s.cnic})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-md",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-4 flex items-center",children:[e.jsx(ye,{className:"w-4 h-4 mr-2 text-green-600"}),"Test Selection"]}),e.jsx("div",{className:"space-y-3 overflow-y-auto",children:f.map((c,N)=>{const D=a.find(m=>m._id===c.test),x=C[c.test]??c.testDetails?.reportStatus??"pending";return e.jsxs("button",{onClick:()=>k(N),className:`w-full text-left p-3 rounded-lg transition-all duration-200 ${R===N?"bg-primary-100 border border-primary-300":"bg-gray-50 hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-gray-800",children:c.testDetails.testName}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${b(x)}`,children:u(x)})]}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:D?.requiresFasting&&e.jsxs("span",{className:"text-orange-500 flex items-center",children:[e.jsx(ee,{className:"mr-1"})," Fasting Required"]})})]},c.test)})})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 shadow-md",children:[e.jsxs("h3",{className:"font-semibold text-gray-800 mb-4 flex items-center",children:[e.jsx(je,{className:"w-4 h-4 mr-2 text-purple-600"}),"Status & Timing"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Test Date"}),e.jsx("p",{className:"font-medium text-gray-800",children:new Date(s.testDate).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Current Status"}),e.jsx("div",{className:"flex items-center mt-1",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${b(v)}`,children:u(v)})})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Delivery Time"}),e.jsx("p",{className:"font-medium text-gray-800",children:a.find(c=>c._id===f[R]?.test)?.reportDeliveryTime||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Payment Status"}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s.paymentStatus==="paid"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.paymentStatus?.toUpperCase()})]})]})]})]})]})},Ae=({selectedTests:s,activeTestIndex:f,onTestChange:a,onSave:R,onSaveAndNext:k,onSaveAndPrev:C,statusByTest:b,getCurrentStatus:u})=>{const j=s.length;s[f];const v=f===0,c=f===j-1;return e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4 mb-6",children:e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[e.jsxs("button",{onClick:C,disabled:v,className:`group flex items-center px-6 py-2.5 rounded-xl font-medium transition-all duration-300 shadow-md ${v?"bg-gray-100 text-gray-400 cursor-not-allowed shadow-none":"bg-linear-to-r from-blue-600 to-blue-700 text-white hover:from-blue-700 hover:to-blue-800 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0"}`,children:[e.jsx(te,{className:`mr-2 transition-transform duration-300 ${!v&&"group-hover:-translate-x-1"}`}),"Previous"]}),e.jsxs("button",{onClick:R,className:"group flex items-center px-6 py-2.5 bg-linear-to-r from-emerald-600 to-green-600 text-white rounded-xl font-medium hover:from-emerald-700 hover:to-green-700 transition-all duration-300 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0",children:[e.jsx(ve,{className:"mr-2 transition-transform duration-300 group-hover:rotate-12"}),"Save"]}),e.jsxs("button",{onClick:k,disabled:c,className:`group flex items-center px-6 py-2.5 rounded-xl font-medium transition-all duration-300 shadow-md ${c?"bg-gray-100 text-gray-400 cursor-not-allowed shadow-none":"bg-linear-to-r from-blue-600 to-blue-700 text-white hover:from-blue-700 hover:to-blue-800 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0"}`,children:["Next",e.jsx(Ne,{className:`ml-2 transition-transform duration-300 ${!c&&"group-hover:translate-x-1"}`})]})]})})})},$e=()=>{const s=ge(),{id:f}=Y(),a=J(),[R,k]=d.useState(!1),[C,b]=d.useState(!1),[u,j]=d.useState([]),[v,c]=d.useState(""),{formData:N,statusByTest:D,setStatusByTest:x,activeTestIndex:m,setActiveTestIndex:S,localStatuses:P,selectedTests:g,testDefinitions:A,patientData:n,patientTestById:r,status:w,error:y,handleFieldChange:T,handleOptionChange:i,saveCurrentTest:t,getCurrentStatus:o}=Te(),E=l=>{if(!r)return null;const h={printData:r},B=(l.length>0?g.filter(p=>l.includes(p.test)):g).map(p=>{const z=N.results[p.test]||[];return{testName:p.testDetails.testName,testId:p.test,fields:z.map(O=>({fieldName:O.fieldName,value:O.value,unit:O.unit,normalRange:O.normalRange,notes:O.notes})),notes:N.notes}});return{patientData:h,testResults:B}},se=`
    <style>
      @page {
        size: A4;
        margin: 0;
      }
      
      body {
        margin: 0;
        padding: 0;
        color: #333;
        font-family: Arial, sans-serif;
        font-size: 12pt;
        line-height: 1.3;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        background: white;
      }

      .page-container {
        width: 210mm;
        min-height: 297mm;
        position: relative;
        page-break-inside: avoid;
      }

      .letterhead-space {
        height: 74mm;
        background-color: transparent;
      }

      .content-area {
        padding: 0 10mm;
        min-height: 223mm;
      }

      .separate-page-test {
        page-break-after: always !important;
        page-break-before: always !important;
      }

      .grouped-tests-page {
        page-break-after: always;
      }

      .grouped-test {
        page-break-inside: avoid;
      }

      .test-divider {
        height: 1mm;
        margin: 6mm 0;
        background-color: #e0e0e0;
        border: none;
        border-radius: 1mm;
      }

      table {
        border-collapse: collapse;
        width: 100%;
      }

      th, td {
        border: 1px solid #ddd;
        padding: 4px 6px;
        text-align: left;
      }

      th {
        background-color: #f0f0f0;
        font-weight: bold;
      }

      .patient-info {
        margin-bottom: 8mm;
      }

      .legal-notice {
        text-align: right;
        margin-bottom: 4mm;
        font-size: 10pt;
        color: #666;
      }

      .test-section {
        margin-bottom: 4mm;
      }

      .test-title {
        font-weight: bold;
        font-size: 13pt;
        margin-bottom: 3mm;
        color: #2b6cb0;
        border-bottom: 2px solid #2b6cb0;
        padding-bottom: 2px;
      }

      @media print {
        body {
          margin: 0;
          padding: 0;
          width: 210mm;
        }
        
        .separate-page-test {
          page-break-after: always !important;
          page-break-before: always !important;
        }
        
        .grouped-tests-page {
          page-break-after: always;
        }
        
        * {
          visibility: visible !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        .letterhead-space {
          background-color: transparent !important;
        }
      }

      .abnormal {
        color: red !important;
        font-weight: bold !important;
      }
    </style>
  `,H=async l=>{try{for(const p of l){const z=A.find(_=>_._id===p);if(!z||!Array.isArray(z.fields)){console.warn("Skipping (no fields):",p);continue}const ue={results:(N?.results?.[p]||[]).filter(_=>_?.fieldName?.trim()?.length).map(_=>({fieldName:_.fieldName,value:_.value,notes:_.notes,testId:p})),status:D[p]??"pending",notes:N.notes??""};await a(Z({patientTestId:f,testId:p,updateData:ue})).unwrap()}const h=E(l);if(!h)return;const F=window.open("","_blank");if(!F){alert("Please allow popups for printing");return}const B=he.renderToStaticMarkup(e.jsx(ke,{patientTest:h.patientData.printData.patientTest,testDefinitions:h.testResults}));F.document.open(),F.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Print Test Report</title>
            ${se}
          </head>
          <body>${B}</body>
          <script>
            window.onload = function() {
              setTimeout(() => {
                window.print();
                window.close();
              }, 500);
            };
          <\/script>
        </html>
      `),F.document.close()}catch(h){alert(`Failed to save and print: ${h.message||"Unknown error"}`)}},I=()=>{j(g.map(l=>l.test)),c(""),b(!0)},re=l=>{j(h=>h.includes(l)?h.filter(F=>F!==l):[...h,l])},ae=()=>{j(g.map(l=>l.test))},ne=()=>{j([])},le=()=>{if(b(!1),u.length===0){alert("Please select at least one test to print.");return}if(n?.paymentStatus!=="paid"){k(!0);return}H(u)},ie=({isOpen:l,onClose:h,onConfirm:F})=>l?e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 animate-slideUp",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-amber-100 p-2 rounded-full",children:e.jsx(ee,{className:"text-amber-600",size:24})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Payment Pending"})]}),e.jsx("button",{onClick:h,className:"text-gray-400 hover:text-gray-600 transition-colors p-1 hover:bg-gray-100 rounded-full",children:e.jsx(L,{size:24})})]}),e.jsx("p",{className:"text-gray-600 mb-8 leading-relaxed",children:"The payment for this report is still pending. Are you sure you want to proceed with printing before payment is confirmed?"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:h,className:"flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-medium transition-all duration-200 hover:shadow-md",children:"Cancel"}),e.jsx("button",{onClick:F,className:"flex-1 px-6 py-3 bg-linear-to-r from-red-600 to-red-700 text-white rounded-xl hover:from-red-700 hover:to-red-800 font-medium transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105",children:"Confirm Print"})]})]})})}):null,oe=({isOpen:l,onClose:h,onPrint:F})=>{if(!l)return null;const B=g.filter(p=>p.testDetails.testName.toLowerCase().includes(v.toLowerCase()));return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all duration-300 animate-slideUp",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900",children:"Select Tests to Print"}),e.jsx("button",{onClick:h,className:"text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full",children:e.jsx(L,{size:24})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400",size:20}),e.jsx("input",{type:"text",value:v,onChange:p=>c(p.target.value),placeholder:"Search tests by name...",className:"w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 bg-gray-50 focus:bg-white"})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs("button",{onClick:ae,className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium transition-all duration-200 shadow-sm hover:shadow-md flex items-center space-x-2",children:[e.jsx(M,{size:16}),e.jsx("span",{children:"Select All"})]}),e.jsx("button",{onClick:ne,className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition-all duration-200",children:"Deselect All"}),e.jsxs("div",{className:"ml-auto flex items-center space-x-2 text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:u.length}),e.jsxs("span",{children:["of ",g.length," selected"]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:B.length>0?e.jsx("div",{className:"space-y-2",children:B.map(p=>{const z=u.includes(p.test),O=o(p.statusHistory);return e.jsxs("label",{className:`flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 ${z?"bg-primary-50 border-primary-500 shadow-md":"bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[e.jsx("input",{type:"checkbox",checked:z,onChange:()=>re(p.test),className:"h-5 w-5 text-primary-600 focus:ring-2 focus:ring-primary-500 border-gray-300 rounded cursor-pointer"}),e.jsx("div",{className:"ml-4 flex-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-900",children:p.testDetails.testName}),e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${O==="completed"?"bg-green-100 text-green-700":O==="pending"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-700"}`,children:O})]})})]},p.test)})}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(W,{className:"text-gray-300 mb-4",size:48}),e.jsx("p",{className:"text-gray-500 font-medium",children:"No tests match your search"}),e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"Try a different search term"})]})}),e.jsx("div",{className:"p-6 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:h,className:"flex-1 px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-medium transition-all duration-200",children:"Cancel"}),e.jsxs("button",{onClick:F,className:"flex-1 px-6 py-3 bg-linear-to-r from-primary-600 to-primary-700 text-white rounded-xl hover:from-primary-700 hover:to-primary-800 font-medium transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none flex items-center justify-center space-x-2",disabled:u.length===0,children:[e.jsx(U,{size:20}),e.jsxs("span",{children:["Print ",u.length," Test",u.length!==1?"s":""]})]})]})})]})})},$=g?.[m]?.test,Q=N?.results?.[$]||[],q=d.useRef([]);d.useRef(null),d.useRef(null),d.useRef(null),d.useEffect(()=>{q.current=Array(Q.length);const l=setTimeout(()=>{const h=q.current?.[0];h&&typeof h.focus=="function"&&h.focus()},0);return()=>clearTimeout(l)},[$,Q.length]);const G=l=>{l>=0&&l<g.length&&S(l)},de=async()=>{try{await t($),G(m+1)}catch(l){console.error("Failed to save and navigate:",l)}},ce=async()=>{try{await t($),G(m-1)}catch(l){console.error("Failed to save and navigate:",l)}},me=async()=>{try{await t($)}catch(l){console.error("Failed to save:",l)}};return w==="loading"?e.jsx(Se,{message:"Loading report..."}):y?e.jsx(X,{error:y,onBack:()=>s(-1)}):!r||!n?e.jsx(X,{error:"No report found",onBack:()=>s(-1)}):e.jsxs("div",{className:"min-h-screen bg-linear-to-br from-blue-50 via-indigo-50 to-purple-50",children:[e.jsx(ie,{isOpen:R,onClose:()=>k(!1),onConfirm:()=>{H(u),k(!1)}}),e.jsx(oe,{isOpen:C,onClose:()=>b(!1),onPrint:le}),e.jsxs("div",{className:" p-4 ",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8",children:[e.jsxs("button",{onClick:()=>s(-1),className:"flex items-center space-x-2 px-6 py-3 bg-white text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-105 group w-fit",children:[e.jsx(te,{className:"group-hover:-translate-x-1 transition-transform",size:20}),e.jsx("span",{className:"font-medium",children:"Back to Reports"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"bg-linear-to-br from-primary-500 to-primary-600 text-white px-6 py-3 rounded-xl shadow-lg",children:[e.jsx("p",{className:"text-xs opacity-90 font-medium uppercase tracking-wide",children:"Token Number"}),e.jsxs("p",{className:"text-2xl font-bold mt-1",children:["#",n.tokenNumber]})]}),e.jsxs("button",{onClick:I,className:"flex items-center space-x-2 px-6 py-3 bg-linear-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105",children:[e.jsx(U,{size:20}),e.jsx("span",{className:"font-medium",children:"Save & Print"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl overflow-hidden",children:[e.jsxs("div",{className:"relative bg-linear-to-r from-primary-600 via-primary-700 to-primary-800 p-8 md:p-10 text-white overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 opacity-10",children:[e.jsx("div",{className:"absolute top-0 left-0 w-64 h-64 bg-white rounded-full -translate-x-32 -translate-y-32"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-96 h-96 bg-white rounded-full translate-x-48 translate-y-48"})]}),e.jsxs("div",{className:"relative flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold mb-4",children:"Al-Shahbaz Modern Diagnostic Center"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs("span",{className:"px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium flex items-center space-x-2",children:[e.jsx(M,{className:"text-green-300"}),e.jsx("span",{children:"ISO Certified Laboratory"})]}),e.jsxs("span",{className:"px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium flex items-center space-x-2",children:[e.jsx(M,{className:"text-green-300"}),e.jsx("span",{children:"Quality Assured"})]})]})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 shadow-xl",children:[e.jsx("p",{className:"text-sm opacity-90 mb-2 font-medium",children:"MR Number"}),e.jsx("p",{className:"text-3xl font-bold",children:n.mrNumber||"N/A"})]})]})]}),e.jsx("div",{className:"p-6 md:p-8",children:e.jsx(Pe,{patientData:n,selectedTests:g,testDefinitions:A,activeTestIndex:m,setActiveTestIndex:S,localStatuses:P,statusByTest:D,getCurrentStatus:o})}),g.length>0&&e.jsx("div",{className:"px-6 md:px-8 pb-8",children:e.jsx(De,{selectedTests:g,testDefinitions:A,activeTestIndex:m,setActiveTestIndex:S,formData:N,handleFieldChange:T,handleOptionChange:i,patientData:n,statusByTest:D,setStatusByTest:x,saveCurrentTest:t,getCurrentStatus:o})})]}),e.jsx("div",{className:"mt-6",children:e.jsx(Ae,{selectedTests:g,activeTestIndex:m,onTestChange:S,onSave:me,onSaveAndNext:de,onSaveAndPrev:ce,statusByTest:D,getCurrentStatus:o})}),e.jsx("div",{className:"flex justify-end mt-6",children:e.jsxs("button",{onClick:I,className:"flex items-center space-x-3 px-8 py-4 bg-linear-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-xl hover:shadow-2xl transform hover:scale-105",children:[e.jsx(U,{size:22}),e.jsx("span",{className:"font-semibold text-lg",children:"Save & Print Report"})]})})]})]})};export{$e as default};
