import{f as v,u as w,r as g,j as e,aI as D,aJ as C,aK as P}from"./index-D_CM1r6M.js";import{d as k,b as F,n as R,m as A,e as M,o as S,p as _,q as V,r as I,s as L,t as $,f as E,F as T}from"./index-C4dsM683.js";import"./iconBase-DSUUJbys.js";const K=({onPatientSelect:t})=>{const a=v(),{loading:m,error:u}=w(n=>n.patients),[o,l]=g.useState(""),c=async n=>{if(n.preventDefault(),o.trim())try{const i=await a(D(o)).unwrap();i.success&&t(i.data)}catch(i){console.error("Search failed:",i)}};return e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-800",children:"Search Patient for Refund"}),e.jsx("form",{onSubmit:c,className:"space-y-4",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(k,{className:"text-gray-400"})}),e.jsx("input",{type:"text",value:o,onChange:n=>l(n.target.value),placeholder:"Enter Patient MR Number",className:"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",disabled:m})]}),e.jsx("button",{type:"submit",disabled:m||!o.trim(),className:"px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed",children:m?"Searching...":"Search"})]})}),u&&e.jsx("div",{className:"mt-4 p-3 bg-red-100 border border-red-200 text-red-700 rounded-lg",children:u})]})},O=({patientData:t,visits:a,onVisitSelect:m,onCancel:u})=>{const[o,l]=g.useState(null),c=s=>{l(s)},n=()=>{if(o){const s=a.find(d=>d._id===o);m(s)}},i=s=>new Intl.NumberFormat("en-PK",{style:"currency",currency:"PKR"}).format(s||0);return!t||!a?e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6",children:e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(F,{className:"animate-spin h-8 w-8 text-primary-600 mr-3"}),e.jsx("span",{children:"Loading patient data..."})]})}):a.length===0?e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(R,{className:"h-12 w-12 text-yellow-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"No Visits Found"}),e.jsx("p",{className:"text-gray-600",children:"This patient has no visit records."}),e.jsx("button",{onClick:u,className:"mt-6 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:"Back to Search"})]})}):e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:t.patient_Name||"Unknown Patient"}),e.jsxs("p",{className:"text-gray-600",children:["MR: ",t.patient_MRNo||"N/A"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Total Visits: ",t.totalVisits||0]}),t.lastVisit&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Last visit: ",new Date(t.lastVisit).toLocaleDateString()]})]})]}),e.jsx("div",{className:"grid gap-4 mb-6",children:a.map((s,d)=>e.jsx("div",{className:`border-2 rounded-lg p-4 cursor-pointer transition-all ${o===s._id?"border-primary-500 bg-primary-50":s.canRefund?"border-gray-200 hover:border-primary-300":"border-gray-100 bg-gray-50 opacity-75"}`,onClick:()=>s.canRefund&&c(s._id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(A,{className:"text-gray-400"}),e.jsx("span",{className:"font-medium",children:s.visitDate?new Date(s.visitDate).toLocaleDateString():"Date not available"}),s.token&&e.jsxs("span",{className:"bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs",children:["Token: ",s.token]})]}),s.doctor?.user?.user_Name&&e.jsxs("div",{className:"flex items-center gap-3 mb-2 text-sm text-gray-600",children:[e.jsx(M,{className:"text-gray-400"}),e.jsxs("span",{children:["Dr. ",s.doctor.user.user_Name]}),s.doctor.doctor_Department&&e.jsx("span",{className:"bg-sky-100 text-sky-700 px-2 py-1 rounded text-xs",children:s.doctor.doctor_Department})]}),s.purpose&&e.jsxs("div",{className:"text-sm text-gray-600 mb-2",children:["Purpose: ",s.purpose]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"text-gray-400"}),e.jsxs("span",{children:["Paid: ",i(s.amountPaid)]})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs("span",{children:["Refunded: ",i(s.totalRefunded)]})}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs("span",{className:"font-semibold",children:["Available: ",i(s.refundable)]})}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs ${s.isFullyRefunded?"bg-green-100 text-green-800":s.refundable>0?"bg-sky-100 text-sky-800":"bg-gray-100 text-gray-800"}`,children:s.isFullyRefunded?"FULLY REFUNDED":s.refundable>0?"REFUND AVAILABLE":"NO REFUND"})})]}),s.refunds&&s.refunds.length>0&&e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:["Previous refunds: ",s.refunds.length]})]}),e.jsx("div",{className:"ml-4",children:o===s._id?e.jsx(_,{className:"h-6 w-6 text-primary-600"}):e.jsx("div",{className:`h-6 w-6 rounded-full border-2 ${s.canRefund?"border-gray-300":"border-gray-200"}`})})]})},s._id||d))}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:u,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:n,disabled:!o,className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Select Visit"})]})]})},U=({patient:t,visit:a,onCancel:m,onSuccess:u})=>{const o=v(),{loading:l,error:c}=w(r=>r.refund),[n,i]=g.useState({refundAmount:Math.max(0,a.amountPaid||0),refundReason:"",refundDescription:"",originalPaymentMethod:a.paymentMethod||"cash",refundMethod:"cash",notes:""}),[s,d]=g.useState(null),f=[{value:"service_not_rendered",label:"Service Not Rendered"},{value:"overpayment",label:"Overpayment"},{value:"cancellation",label:"Cancellation"},{value:"dissatisfaction",label:"Patient Dissatisfaction"},{value:"duplicate_payment",label:"Duplicate Payment"},{value:"other",label:"Other"}],j=[{value:"cash",label:"Cash"},{value:"card",label:"Card"},{value:"bank_transfer",label:"Bank Transfer"},{value:"online",label:"Online"},{value:"other",label:"Other"}],y=[{value:"cash",label:"Cash"},{value:"bank_transfer",label:"Bank Transfer"},{value:"credit_note",label:"Credit Note"},{value:"adjustment",label:"Adjustment"},{value:"other",label:"Other"}],b=async r=>{if(r.preventDefault(),d(null),!n.refundReason){d("Please select a refund reason");return}if(!n.refundAmount||n.refundAmount<=0){d("Please enter a valid refund amount");return}if(n.refundAmount>(a.amountPaid||0)){d(`Refund amount cannot exceed paid amount of ${x(a.amountPaid)}`);return}const N={patientMRNo:t.patient_MRNo,visitId:a._id,...n,refundAmount:parseFloat(n.refundAmount)};try{const p=await o(C(N)).unwrap();p.success?u(p.data):d(p.message||"Failed to create refund")}catch(p){console.error("Failed to create refund:",p),d(p.message||"An error occurred while processing the refund")}},h=(r,N)=>{i(p=>({...p,[r]:N})),s&&d(null)},x=r=>new Intl.NumberFormat("en-PK",{style:"currency",currency:"PKR"}).format(r||0);return e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Process Refund"}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["For ",t.patient_Name," (MR: ",t.patient_MRNo,") - Visit on ",new Date(a.visitDate).toLocaleDateString()]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"font-medium text-gray-800 mb-3",children:"Visit Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Amount Paid:"}),e.jsx("span",{className:"font-medium ml-2",children:x(a.amountPaid)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Payment Method:"}),e.jsx("span",{className:"font-medium ml-2 capitalize",children:a.paymentMethod})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Payment Status:"}),e.jsx("span",{className:`font-medium ml-2 capitalize ${a.amountStatus==="paid"?"text-green-600":a.amountStatus==="partial"?"text-yellow-600":"text-red-600"}`,children:a.amountStatus})]}),a.doctor?.user?.user_Name&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Doctor:"}),e.jsxs("span",{className:"font-medium ml-2",children:["Dr. ",a.doctor.user.user_Name]})]})]})]}),(c||s)&&e.jsxs("div",{className:"mb-6 p-3 bg-red-100 border border-red-200 text-red-700 rounded-lg flex items-center",children:[e.jsx(R,{className:"mr-2 shrink-0"}),e.jsx("span",{children:c||s})]}),e.jsxs("form",{onSubmit:b,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Refund Amount (Max: ",x(a.amountPaid),")"]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(S,{className:"text-gray-400"})}),e.jsx("input",{type:"number",value:n.refundAmount,onChange:r=>h("refundAmount",Math.min(parseFloat(r.target.value)||0,a.amountPaid||0)),min:"0",max:a.amountPaid||0,step:"0.01",className:"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",required:!0})]}),e.jsxs("div",{className:"text-sm text-gray-500 mt-1",children:["Maximum refundable amount: ",x(a.amountPaid)]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Refund Reason *"}),e.jsxs("select",{value:n.refundReason,onChange:r=>h("refundReason",r.target.value),className:"block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",required:!0,children:[e.jsx("option",{value:"",children:"Select reason"}),f.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 pt-3 pointer-events-none",children:e.jsx(V,{className:"text-gray-400"})}),e.jsx("textarea",{value:n.refundDescription,onChange:r=>h("refundDescription",r.target.value),rows:3,className:"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",placeholder:"Provide details about the refund..."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Original Payment Method"}),e.jsx("select",{value:n.originalPaymentMethod,onChange:r=>h("originalPaymentMethod",r.target.value),className:"block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",required:!0,children:j.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Refund Method *"}),e.jsx("select",{value:n.refundMethod,onChange:r=>h("refundMethod",r.target.value),className:"block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",required:!0,children:y.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Additional Notes"}),e.jsx("textarea",{value:n.notes,onChange:r=>h("notes",r.target.value),rows:2,className:"block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",placeholder:"Any additional information..."})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:m,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",disabled:l,children:"Cancel"}),e.jsx("button",{type:"submit",disabled:l,className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center min-w-[120px]",children:l?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"animate-spin mr-2"}),"Processing..."]}):"Process Refund"})]})]})]})},B=({refund:t,patient:a,visit:m,onNewRefund:u})=>{const o=s=>new Intl.NumberFormat("en-PK",{style:"currency",currency:"PKR"}).format(s||0),l=s=>s?(typeof s=="string"?s:String(s)).replace(/_/g," ").replace(/\b\w/g,f=>f.toUpperCase()):"Not specified",c=s=>{if(!s)return"Date not available";try{return new Date(s).toLocaleDateString()}catch{return"Invalid date"}},n=()=>{window.print()},i=()=>{const s=`
      Refund ID: ${t?._id||"N/A"}
      Patient: ${a?.patient_Name||"N/A"} (MR: ${a?.patient_MRNo||"N/A"})
      Amount: ${o(t?.refundAmount)}
      Date: ${c(t?.refundDate)}
      Reason: ${l(t?.refundReason)}
    `;navigator.clipboard.writeText(s).then(()=>{alert("Refund details copied to clipboard!")}).catch(d=>{console.error("Failed to copy details: ",d)})};return!t||!a||!m?e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(R,{className:"h-16 w-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Data Not Available"}),e.jsx("p",{className:"text-gray-600",children:"Some refund information is missing or incomplete."})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:u,className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:"Start New Refund"})})]}):e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(L,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Refund Processed Successfully!"}),e.jsx("p",{className:"text-gray-600",children:"The refund has been processed and recorded in the system."})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"font-semibold text-green-800 mb-3",children:"Refund Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Refund ID:"}),e.jsx("span",{className:"font-medium ml-2",children:t._id||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Amount:"}),e.jsx("span",{className:"font-medium ml-2",children:o(t.refundAmount)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Date:"}),e.jsx("span",{className:"font-medium ml-2",children:c(t.refundDate)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Status:"}),e.jsx("span",{className:"font-medium ml-2 capitalize",children:t.status||t.refundStatus||"completed"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Reason:"}),e.jsx("span",{className:"font-medium ml-2 capitalize",children:l(t.refundReason)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Method:"}),e.jsx("span",{className:"font-medium ml-2 capitalize",children:t.refundMethod||"cash"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3",children:"Patient Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Name:"}),e.jsx("span",{className:"font-medium ml-2",children:a.patient_Name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"MR Number:"}),e.jsx("span",{className:"font-medium ml-2",children:a.patient_MRNo||"N/A"})]}),a.patient_ContactNo&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Contact:"}),e.jsx("span",{className:"font-medium ml-2",children:a.patient_ContactNo})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Visit Date:"}),e.jsx("span",{className:"font-medium ml-2",children:c(m.visitDate)})]})]})]}),e.jsxs("div",{className:"flex justify-center gap-4 flex-wrap",children:[e.jsxs("button",{onClick:i,className:"flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:[e.jsx($,{className:"mr-2"}),"Copy Details"]}),e.jsxs("button",{onClick:n,className:"flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:[e.jsx(E,{className:"mr-2"}),"Print Receipt"]}),e.jsx("button",{onClick:u,className:"px-4 py-2 border border-primary-600 text-primary-600 rounded-lg hover:bg-primary-50",children:"New Refund"})]})]})},J=()=>{const t=v(),{patientData:a,visits:m,refunds:u,refundSummary:o}=w(x=>x.patients),[l,c]=g.useState("search"),[n,i]=g.useState(null),[s,d]=g.useState(null),f=x=>{c("visit-selection")},j=x=>{i(x),c("refund-form")},y=x=>{d(x),c("success")},b=()=>{l==="visit-selection"?c("search"):l==="refund-form"?(i(null),c("visit-selection")):l==="success"&&(d(null),i(null),t(P()),c("search"))},h=()=>{d(null),i(null),t(P()),c("search")};return e.jsx("div",{children:e.jsxs("div",{className:"",children:[e.jsxs("div",{className:"flex items-center mb-3  bg-primary-700 p-9 rounded-lg shadow-md",children:[l!=="search"&&e.jsxs("button",{onClick:b,className:"flex items-center bg-primary-100 p-1  rounded-tr-lg  text-primary-600 hover:text-primary-700 mr-4 ",children:[e.jsx(T,{className:"mr-1"}),"Back"]}),e.jsxs("div",{className:"flex items-center border-l-4 border-primary-300 pl-4",children:[e.jsx("div",{className:"bg-primary-100 p-3 rounded-full mr-4",children:e.jsx(S,{className:"h-6 w-6 text-primary-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-100",children:"Refund Management"}),e.jsx("p",{className:"text-gray-200",children:"Process patient refunds efficiently"})]})]})]}),l==="search"&&e.jsx(K,{onPatientSelect:f}),l==="visit-selection"&&a&&e.jsx(O,{patientData:a,visits:m,onVisitSelect:j,onCancel:b}),l==="refund-form"&&a&&n&&e.jsx(U,{patient:a,visit:n,onCancel:b,onSuccess:y}),l==="success"&&s&&a&&e.jsx(B,{refund:s,patient:a,visit:n,onNewRefund:h})]})})};export{J as default};
