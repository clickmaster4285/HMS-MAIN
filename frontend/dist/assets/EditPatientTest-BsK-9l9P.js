import{T as yt,f as At,d as Nt,u as ot,r as w,bU as bt,bO as St,j as o,y as P,bV as jt}from"./index-D_CM1r6M.js";import{B as O,a as wt}from"./Buttons-B9m6-61d.js";import{F as K}from"./FormSection-CqnVxHJP.js";import{P as Mt,T as Dt}from"./TestInfo-oPe2ns1S.js";import"./FormFields-cbkv4QEu.js";import"./index-CVhLpNpZ.js";import"./iconBase-DSUUJbys.js";import"./index-jLjFIv2f.js";import"./index-DK6bWzrh.js";import"./index-Dskypj5f.js";import"./doctors-Bv8ssxVQ.js";const Pt=f=>f?typeof f=="string"?f:f.$oid?f.$oid:f._id&&typeof f._id=="string"?f._id:f._id&&typeof f._id=="object"&&f._id.$oid?f._id.$oid:f.$id?f.$id:String(f):"",it=f=>{if(!f)return new Date().toISOString().slice(0,10);const D=new Date(f);return isNaN(D.getTime())?new Date().toISOString().slice(0,10):D.toISOString().slice(0,10)},I=f=>`Rs. ${Number(f||0).toFixed(2)}`,Ot=()=>{const{id:f}=yt(),D=At(),L=Nt(),q=ot(t=>t.patientTest.tests),k=ot(t=>t.patientTest.patientTestById),[S,z]=w.useState({MRNo:"",CNIC:"",Name:"",ContactNo:"",Gender:"",Age:"",ReferredBy:"",Guardian:"",MaritalStatus:""}),[$,J]=w.useState(""),[N,C]=w.useState([]),[H,v]=w.useState({isExternalPatient:!1,tokenNumber:"",paymentStatus:"unpaid"}),[A,_]=w.useState({totalAmount:0,discountAmount:0,advanceAmount:0,remainingAmount:0,cancelledAmount:0,refundableAmount:0,paidAfterReport:0}),[rt,dt]=w.useState(null),[R,U]=w.useState(0),[Q,W]=w.useState([]),[ct,X]=w.useState(0),[T,Y]=w.useState(0);w.useEffect(()=>{D(bt(f)),D(St())},[D,f]),w.useEffect(()=>{if(!k)return;const t=k.patientTest||k,a=t.patient_Detail||{};z({MRNo:a.patient_MRNo||"",CNIC:a.patient_CNIC||"",Name:a.patient_Name||"",ContactNo:a.patient_ContactNo||"",Gender:a.patient_Gender||"",Age:a.patient_Age||"",ReferredBy:a.referredBy||"",Guardian:a.patient_Guardian||"",MaritalStatus:a.maritalStatus||""});const u=(t.selectedTests||[]).map((r,h)=>{const i=r.testDetails||{},p=Number(i.testPrice??0),b=Number(i.discountAmount??0),M=Number(i.advanceAmount??0),B=Math.max(0,p-b),E=Math.max(0,B-M);return{srNo:h+1,testId:Pt(r.test),testName:i.testName||"",testCode:i.testCode||"",sampleDate:it(i.testDate||r.testDate),reportDate:"",amount:p,discount:b,finalAmount:B,paid:M,remaining:E,sampleStatus:i.sampleStatus||r.sampleStatus||"pending",reportStatus:i.reportStatus||r.reportStatus||"not_started",testStatus:r.testStatus||"registered",statusHistory:r.statusHistory||[],notes:r.notes||""}});C(u);const s=u.reduce((r,h)=>r+(h.amount||0),0),d=u.reduce((r,h)=>r+(h.discount||0),0),g=s-d,m=u.reduce((r,h)=>r+(h.paid||0),0),n=Math.max(0,g-m);let y="unpaid";n===0&&m>0?y="paid":m>0&&(y="partial"),v({isExternalPatient:!!t.isExternalPatient,tokenNumber:t.tokenNumber??"",paymentStatus:y}),_({totalAmount:s,discountAmount:d,advanceAmount:m,remainingAmount:n,cancelledAmount:t.cancelledAmount??0,refundableAmount:t.refundableAmount??0,paidAfterReport:t.paidAfterReport??0});const x=[];m>0&&x.push({date:new Date().toISOString(),amount:m,type:"initial",description:"Initial payment"}),W(x),X(m),U(0)},[k]);const mt=t=>{const{name:a,value:u}=t.target;z(s=>({...s,[a]:u}))},ut=()=>L(-1),lt=()=>{if(!$)return;const t=q.find(d=>d._id===$);if(!t)return;const a=Number(t.testPrice||0),u=Number(t.discountAmount||0),s=Math.max(0,a-u);C(d=>[...d,{srNo:d.length+1,testId:t._id,testName:t.testName||"",testCode:t.testCode||"",sampleDate:it(new Date),reportDate:"",amount:a,discount:u,finalAmount:s,paid:0,remaining:s,sampleStatus:"pending",reportStatus:"not_started",testStatus:"registered",statusHistory:[],notes:""}]),J("")},pt=(t,a,u)=>{const s=[...N];if(["amount","discount","paid"].includes(a)){const r=Math.max(0,Number(u));s[t][a]=r;const h=Number(s[t].amount||0),i=Number(s[t].discount||0),p=Number(s[t].paid||0),b=Math.max(0,h-i);s[t].finalAmount=b,s[t].remaining=Math.max(0,b-p)}else s[t][a]=u;C(s);const d=s.reduce((r,h)=>r+(h.amount||0),0),g=s.reduce((r,h)=>r+(h.discount||0),0),m=d-g,n=s.reduce((r,h)=>r+(h.paid||0),0),y=Math.max(0,m-n);_(r=>({...r,totalAmount:d,discountAmount:g,advanceAmount:n,remainingAmount:y}));let x="unpaid";y===0&&n>0?x="paid":n>0&&(x="partial"),v(r=>({...r,paymentStatus:x}))},xt=t=>{const u=N.filter((x,r)=>r!==t).map((x,r)=>({...x,srNo:r+1}));C(u);const s=u.reduce((x,r)=>x+(r.amount||0),0),d=u.reduce((x,r)=>x+(r.discount||0),0),g=s-d,m=u.reduce((x,r)=>x+(r.paid||0),0),n=Math.max(0,g-m);_(x=>({...x,totalAmount:s,discountAmount:d,advanceAmount:m,remainingAmount:n}));let y="unpaid";n===0&&m>0?y="paid":m>0&&(y="partial"),v(x=>({...x,paymentStatus:y}))},Z=t=>{if(!N.length)return;const a=N.map(e=>({...e})),u=a.reduce((e,c)=>e+l(c.paid),0),s=a.map(e=>({...e})),d=s.map(e=>Math.max(0,l(e.amount))),g=d.reduce((e,c)=>e+c,0),m=Math.max(0,Math.min(l(t),g));let n=s.map((e,c)=>Math.floor(m*(d[c]/(g||1)))),y=n.reduce((e,c)=>e+c,0),x=m-y;const r=s.map((e,c)=>c).sort((e,c)=>d[c]-d[e]);for(const e of r){if(x<=0)break;n[e]<d[e]&&(n[e]+=1,x-=1)}let h=0;for(let e=0;e<n.length;e++)n[e]>d[e]&&(h+=n[e]-d[e],n[e]=d[e]);if(h>0){const e=s.map((c,j)=>j).sort((c,j)=>d[j]-n[j]-(d[c]-n[c]));for(const c of e){if(h<=0)break;const j=d[c]-n[c];if(j<=0)continue;const G=Math.min(j,h);n[c]+=G,h-=G}}for(let e=0;e<s.length;e++){const c=l(s[e].amount),j=Math.max(0,Math.min(n[e],c)),G=Math.max(0,c-j);s[e].discount=j,s[e].finalAmount=G}const i=s.reduce((e,c)=>e+l(c.finalAmount),0),p=Math.min(u,i);for(const e of s)e.paid=0,e.remaining=e.finalAmount;let b=p;const M=s.map((e,c)=>c).sort((e,c)=>s[c].finalAmount-s[e].finalAmount);for(const e of M){if(b<=0)break;const c=Math.max(0,l(s[e].finalAmount)-l(s[e].paid));if(c<=0)continue;const j=Math.min(c,b);s[e].paid+=j,s[e].remaining=Math.max(0,s[e].finalAmount-s[e].paid),b-=j}const B=Math.max(0,u-p),E=s.reduce((e,c)=>e+l(c.amount),0),nt=s.reduce((e,c)=>e+l(c.discount),0),F=s.reduce((e,c)=>e+l(c.paid),0),st=Math.max(0,E-nt-F);C(s),_(e=>({...e,totalAmount:E,discountAmount:nt,advanceAmount:F,remainingAmount:st,refundableAmount:l(e.refundableAmount)+B})),v(e=>({...e,paymentStatus:st===0&&F>0?"paid":F>0?"partial":"unpaid"}))},l=t=>{const a=Number(t);return Number.isFinite(a)?a:0},tt=()=>{const t=Math.max(0,Number(T)||0),a=N.reduce((g,m)=>g+l(m.amount),0),u=N.reduce((g,m)=>g+l(m.discount),0),s=Math.max(0,a-u);if(t<=0||t>s){P.error("Invalid additional discount amount");return}const d=u+t;Z(d),Y(0)},et=t=>{const a=[...N],u=a.reduce((i,p)=>i+l(p.amount),0),s=a.reduce((i,p)=>i+l(p.discount),0),d=Math.max(0,u-s),g=Math.min(Math.max(0,l(t)),d),m=a.reduce((i,p)=>i+l(p.paid),0);let n=g-m;if(n<=0){const i=Math.max(0,d-m);_(p=>({...p,totalAmount:u,discountAmount:s,advanceAmount:m,remainingAmount:i})),v(p=>({...p,paymentStatus:i===0&&m>0?"paid":m>0?"partial":"unpaid"}));return}const y=a.map((i,p)=>p).sort((i,p)=>{const b=Math.max(0,l(a[i].amount)-l(a[i].discount))-l(a[i].paid);return Math.max(0,l(a[p].amount)-l(a[p].discount))-l(a[p].paid)-b});for(const i of y){if(n<=0)break;const p=Math.max(0,l(a[i].amount)-l(a[i].discount)),b=Math.max(0,p-l(a[i].paid));if(b<=0)continue;const M=Math.min(b,n);a[i].paid=l(a[i].paid)+M,a[i].finalAmount=p,a[i].remaining=Math.max(0,p-a[i].paid),n-=M}C(a);const x=a.reduce((i,p)=>i+l(p.paid),0),r=Math.max(0,d-x),h=x-m;h>0&&(W(i=>[...i,{date:new Date().toISOString(),amount:h,type:"additional",description:"Additional payment"}]),X(i=>i+h)),_(i=>({...i,totalAmount:u,discountAmount:s,advanceAmount:x,remainingAmount:r})),v(i=>({...i,paymentStatus:r===0&&x>0?"paid":x>0?"partial":"unpaid"}))},at=()=>{const t=Math.max(0,Number(R)||0),a=N.reduce((m,n)=>m+l(n.amount),0),u=N.reduce((m,n)=>m+l(n.discount),0),s=Math.max(0,a-u),d=N.reduce((m,n)=>m+l(n.paid),0),g=Math.max(0,s-d);if(t<=0){P.error("Enter a payment greater than 0");return}if(t>g){P.error(`Payment cannot exceed remaining balance (${I(g)})`);return}et(d+t),U(0)},ht=async t=>{if(t.preventDefault(),!S.Name||!S.Gender||!S.ContactNo){P.error("Please fill all required patient fields");return}if(N.length===0){P.error("Please add at least one test");return}const a=N.reduce((n,y)=>n+(y.amount||0),0),u=N.reduce((n,y)=>n+(y.discount||0),0),s=a-u,d=N.reduce((n,y)=>n+(y.paid||0),0),g=Math.max(0,s-d),m={patientTestId:f,patient_Detail:{patient_MRNo:S.MRNo,patient_CNIC:S.CNIC,patient_Name:S.Name,patient_Guardian:S.Guardian,patient_ContactNo:S.ContactNo,patient_Gender:S.Gender,patient_Age:S.Age,referredBy:S.ReferredBy,maritalStatus:S.MaritalStatus},isExternalPatient:H.isExternalPatient,selectedTests:N.map(n=>({test:n.testId,testDetails:{testName:n.testName,testCode:n.testCode,testPrice:n.amount,discountAmount:n.discount,advanceAmount:n.paid,remainingAmount:n.remaining,testDate:n.sampleDate,sampleStatus:n.sampleStatus,reportStatus:n.reportStatus},testStatus:n.testStatus,statusHistory:n.statusHistory,notes:n.notes})),financialSummary:{totalAmount:a,totalDiscount:u,totalPaid:d,totalRemaining:g,cancelledAmount:A.cancelledAmount,refundableAmount:A.refundableAmount,paidAfterReport:A.paidAfterReport,paymentStatus:H.paymentStatus},tokenNumber:H.tokenNumber};try{await D(jt(m)).unwrap(),P.success("Patient test updated successfully"),L(-1)}catch(n){console.error("❌ Update error:",n),P.error(`Update failed: ${n.message}`)}},ft=N.reduce((t,a)=>t+(Number(a.amount)||0),0),gt=N.reduce((t,a)=>t+(Number(a.discount)||0),0),V=Math.max(0,ft-gt);return o.jsxs("form",{onSubmit:ht,className:"p-6 bg-white rounded shadow-md space-y-10",children:[o.jsx("div",{className:"w-screen -ml-6 bg-teal-600 py-6 text-white text-3xl font-bold shadow",children:o.jsx("h1",{className:"ml-4",children:"Edit Patient Test"})}),o.jsx(K,{title:"Patient Information",bgColor:"bg-primary-700 text-white",children:o.jsx(Mt,{mode:"edit",patient:S,dob:rt,handlePatientChange:mt,handleSearch:()=>{},handleDobChange:dt,setMode:()=>{},useDefaultContact:!1,setUseDefaultContact:()=>{},defaultContactNumber:""})}),o.jsx(K,{title:"Test Information",bgColor:"bg-primary-700 text-white",children:o.jsx(Dt,{testList:q,selectedTestId:$,setSelectedTestId:J,testRows:N,handleTestAdd:lt,handleTestRowChange:pt,handleRemoveRow:xt,totalAmount:A.totalAmount,totalDiscount:A.discountAmount,totalFinalAmount:A.totalAmount-A.discountAmount,totalPaid:A.advanceAmount,overallRemaining:A.remainingAmount,applyOverallDiscount:Z,applyOverallPaid:et,mode:"edit",paidBoxValue:A.advanceAmount,discountBoxValue:A.discountAmount})}),o.jsx(K,{title:"Billing Information",bgColor:"bg-primary-700 text-white",children:o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[o.jsxs("div",{className:"max-w-xs",children:[o.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remaining Balance"}),o.jsx("input",{type:"number",readOnly:!0,value:Number(A.remainingAmount||0).toFixed(2),className:"mt-1 block w-full px-3 py-2 rounded-md border border-gray-300 bg-gray-100 text-gray-700"}),o.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"This updates automatically as you type in “Set Total Paid”."})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[A.remainingAmount>0&&o.jsxs("div",{className:"mt-4",children:[o.jsx("label",{htmlFor:"additionalPayment",className:"block text-sm font-medium text-gray-700",children:"Additional Payment"}),o.jsxs("div",{className:"mt-1 flex rounded-md shadow-sm",children:[o.jsx("input",{type:"number",id:"additionalPayment",name:"additionalPayment",value:R,onChange:t=>{const a=Math.max(0,Number(t.target.value));U(a)},onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),R>0&&R<=A.remainingAmount&&at())},min:"0",max:A.remainingAmount,className:"flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md border border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"Enter amount"}),o.jsx(O,{type:"button",variant:"primary",onClick:at,disabled:R<=0||R>A.remainingAmount,className:"rounded-l-none",children:"Apply"})]})]}),o.jsxs("div",{className:"mt-4",children:[o.jsx("label",{htmlFor:"additionalDiscount",className:"block text-sm font-medium text-gray-700",children:"Additional Discount"}),o.jsxs("div",{className:"mt-1 flex rounded-md shadow-sm",children:[o.jsx("input",{type:"number",id:"additionalDiscount",name:"additionalDiscount",value:T,onChange:t=>{const a=Math.max(0,Number(t.target.value));Y(a)},onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),T>0&&T<=V&&tt())},min:"0",max:V,className:"flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md border border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"Enter discount"}),o.jsx(O,{type:"button",variant:"primary",onClick:tt,disabled:T<=0||T>V,className:"rounded-l-none",children:"Apply"})]})]})]})]}),Q.length>0&&o.jsxs("div",{className:"mt-6",children:[o.jsx("h3",{className:"text-lg font-medium mb-2",children:"Payment History"}),o.jsx("div",{className:"bg-gray-50 p-4 rounded-md",children:o.jsx("div",{className:"overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-md",children:o.jsxs("table",{className:"min-w-full divide-y divide-gray-300",children:[o.jsx("thead",{className:"bg-gray-100",children:o.jsxs("tr",{children:[o.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Date"}),o.jsx("th",{className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Description"}),o.jsx("th",{className:"px-3 py-3.5 text-right text-sm font-semibold text-gray-900",children:"Amount"})]})}),o.jsxs("tbody",{className:"divide-y divide-gray-200 bg-white",children:[Q.map((t,a)=>o.jsxs("tr",{children:[o.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-500",children:new Date(t.date).toLocaleDateString()}),o.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-500",children:t.description}),o.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-500 text-right",children:o.jsxs("span",{className:"text-green-600 font-medium",children:["+",I(t.amount)]})})]},a)),o.jsxs("tr",{className:"bg-gray-50 font-medium",children:[o.jsx("td",{colSpan:"2",className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:"Discount:"}),o.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:I(A.discountAmount)})]}),o.jsxs("tr",{className:"bg-gray-50 font-medium",children:[o.jsx("td",{colSpan:"2",className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:"Total Amount:"}),o.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:I(A.totalAmount)})]}),o.jsxs("tr",{className:"bg-gray-50 font-medium",children:[o.jsx("td",{colSpan:"2",className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:"Total Payments:"}),o.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:I(ct)})]}),o.jsxs("tr",{className:"bg-gray-50 font-medium",children:[o.jsx("td",{colSpan:"2",className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:"Remaining Payments:"}),o.jsx("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-900 text-right",children:I(A.remainingAmount)})]})]})]})})})]})]})}),o.jsxs(wt,{className:"justify-end",children:[o.jsx(O,{type:"button",variant:"secondary",onClick:ut,children:"Cancel"}),o.jsx(O,{type:"submit",variant:"primary",children:"Update"})]})]})};export{Ot as default};
