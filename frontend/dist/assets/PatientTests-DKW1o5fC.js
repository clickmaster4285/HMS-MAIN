import{f as W,d as Y,u as J,r as c,i as I,j as e,bT as K,y as L}from"./index-D_CM1r6M.js";import{d as V,v as X,k as Z,l as ee,f as te,g as se,c as ae,h as re,i as ne}from"./index-C4dsM683.js";import{P as ie}from"./PrintPatientTest-kJOah_91.js";import{R as oe}from"./server.browser-DuO4EFVg.js";import{f as E}from"./format-C6WB0tTj.js";import"./iconBase-DSUUJbys.js";import"./logo1-Cp_MkaTU.js";const le=n=>{const r=n?.patient_Detail||n?.patient||{},P=s=>{if(!s||typeof s!="string")return s;try{const o=s.match(/(\d+)\s*years?/),m=s.match(/(\d+)\s*months?/),y=s.match(/(\d+)\s*days?/),u=o?o[1]:"0",f=m?m[1]:"0",N=y?y[1]:"0";return`${u}/${f}/${N}`}catch(o){return console.warn("Error parsing age:",s,o),s}},h=(Array.isArray(n?.tests)&&n.tests.length?n.tests:Array.isArray(n?.selectedTests)?n.selectedTests:[]).map(s=>{if(s?.testName||s?.price!==void 0){const C=Number(s?.price??0),D=Math.max(0,Number(s?.discount??0)),M=Math.max(0,Number(s?.paid??0)),b=Math.max(0,C-D),R=Math.max(0,b-M);return{...s,_norm:{testName:s?.testName||"Unknown Test",testCode:s?.testCode||"",price:C,discount:D,paid:M,finalAmount:b,remaining:R},testDate:s?.testDate||s?.sampleDate||null}}const o=s?.testDetails||s?.test||{},m=o?.testName||s?.testName||"Unknown Test",y=o?.testCode||s?.testCode||"",u=Number(s?.testPrice??o?.testPrice??0),f=Math.max(0,Number(s?.discountAmount||0)),N=Math.max(0,Number(s?.advanceAmount||0)),w=Math.max(0,u-f),v=Math.max(0,w-N);return{...s,_norm:{testName:m,testCode:y,price:u,discount:f,paid:N,finalAmount:w,remaining:v},testDate:s?.testDate||s?.sampleDate||null}}),l=n?.financialSummary||{},j=h.reduce((s,o)=>s+o._norm.finalAmount,0),T=Number(l.totalAmount??n?.totalAmount??0)||h.reduce((s,o)=>s+o._norm.price,0),g=Number(l.totalPaid??n?.totalPaid??n?.advanceAmount??0)||h.reduce((s,o)=>s+o._norm.paid,0),F=Number(l.totalDiscount??n?.discountAmount??0)||h.reduce((s,o)=>s+o._norm.discount,0),d=Number(l.totalRemaining??n?.remainingAmount??Math.max(0,j-g)),k=l.paymentStatus||n?.paymentStatus||(d===0?"paid":g>0?"partial":"pending");return{...n,_norm:{patient:{MRNo:r?.patient_MRNo||r?.MRNo||r?.mrNo||"",Name:r?.patient_Name||r?.Name||r?.name||"",CNIC:r?.patient_CNIC||r?.CNIC||r?.cnic||"",ContactNo:r?.patient_ContactNo||r?.ContactNo||r?.contactNo||"",Contact:r?.patient_ContactNo||r?.ContactNo||r?.contactNo||"",Gender:r?.patient_Gender||r?.Gender||r?.gender||"",Age:P(r?.patient_Age||r?.Age||r?.age||""),Guardian:r?.patient_Guardian||r?.Guardian||r?.guardian||"",ReferredBy:r?.referredBy||r?.ReferredBy||n?.referredBy||""},selectedTests:h,totalAmount:T,totalDiscount:F,totalPaid:g,remainingAmount:d,paymentStatus:k,tokenNumber:n?.tokenNumber??"",createdAt:n?.createdAt??null,updatedAt:n?.updatedAt??n?.financialSummary?.updatedAt??n?.modifiedAt??null,referredBy:n?.referredBy??r?.referredBy??r?.ReferredBy??""}}},ge=()=>{const n=W(),r=Y(),{allPatientTests:P,status:S,error:h,pagination:l}=J(t=>t.patientTest),[j,T]=c.useState(""),[g,F]=c.useState(!1),[d,k]=c.useState({status:"",dateRange:"",gender:"",contact:""}),[s,o]=c.useState(1),[m,y]=c.useState(20),[u,f]=c.useState(""),[N,w]=c.useState(!1),[v,C]=c.useState(null),D=t=>{C(t),w(!0)},M=()=>{w(!1),C(null)},b=c.useCallback(()=>{const t={page:s,limit:m};u&&(t.search=u);let a="";return d.status&&(a+=`status:${d.status} `),d.gender&&(a+=`gender:${d.gender} `),d.contact&&(a+=`contact:${d.contact} `),a&&(t.search=t.search?`${t.search} ${a}`:a),t},[s,m,u,d]);c.useEffect(()=>{const t=b();n(I(t))},[n,b]);const R=c.useMemo(()=>(P||[]).map(le),[P]),G=c.useCallback(t=>[...t].sort((a,i)=>{const p=new Date(a._norm.createdAt||0).getTime();return new Date(i._norm.createdAt||0).getTime()-p}),[]),[$,B]=c.useState([]);c.useEffect(()=>{B(G(R))},[R,G]),c.useEffect(()=>{const t=setTimeout(()=>{f(j),o(1)},500);return()=>clearTimeout(t)},[j]);const O=t=>{r(`/lab/patient-tests/edit/${t}`)},z=async t=>{if(window.confirm("Are you sure you want to delete this patient test record?")){const a=$;B(i=>i.filter(p=>p._id!==t));try{await n(K(t)).unwrap();const i=b();n(I(i)),L.success("Record deleted successfully")}catch(i){B(a),console.error("Delete failed:",i),L.error(`Delete failed: ${i?.message||"Unknown error"}`)}}},U=t=>{const a={tokenNumber:t.tokenNumber,patient:{MRNo:t.patient.MRNo,Name:t.patient.Name,CNIC:t.patient.CNIC,ContactNo:t.patient.ContactNo,Gender:t.patient.Gender,Age:t.patient.Age,ReferredBy:t.referredBy||t.patient.ReferredBy||"",Guardian:t.patient.Guardian,MaritalStatus:t.patient.MaritalStatus},tests:t.selectedTests.map(x=>({testName:x._norm.testName,price:x._norm.price,discount:x._norm.discount,paid:x._norm.paid,finalAmount:x._norm.finalAmount})),totalAmount:t.totalAmount,totalDiscount:t.totalDiscount,totalPaid:t.totalPaid,remaining:t.remainingAmount,sampleDate:t.selectedTests[0]?.testDate?E(new Date(t.selectedTests[0].testDate),"yyyy-MM-dd"):"",reportDate:t.selectedTests[0]?.testDate?E(new Date(t.selectedTests[0].testDate),"yyyy-MM-dd"):""},i=window.open("","_blank");if(!i){const x=document.createElement("div");x.style=`
      position: fixed; top: 20px; right: 20px; padding: 15px; background: #ffeb3b;
      border: 1px solid #ffc107; border-radius: 4px; z-index: 9999;
    `,x.innerHTML=`
      <p>Popup blocked! Please allow popups for this site.</p>
      <button onclick="this.parentNode.remove()">Dismiss</button>
    `,document.body.appendChild(x);return}const p=oe.renderToStaticMarkup(e.jsx(ie,{formData:a}));i.document.open(),i.document.write(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>Print Patient Test</title>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
        <style>
          body { font-family: Arial, sans-serif; padding: 10mm; color: #333; font-size: 14px; }
          .header { display: flex; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
          .logo { height: 60px; margin-right: 20px; }
        </style>
      </head>
      <body>${p}</body>
      <script>
        setTimeout(() => {
          window.print();
          window.onafterprint = function() { window.close(); };
        }, 500);
      <\/script>
    </html>
  `),i.document.close()},A=t=>{t>=1&&t<=(l?.totalPages||1)&&o(t)},q=t=>{const a=parseInt(t.target.value);y(a),o(1)},_=t=>{const{name:a,value:i}=t.target;k(p=>({...p,[a]:i})),o(1)},H=()=>{k({status:"",dateRange:"",gender:"",contact:""}),T(""),o(1)},Q=()=>{const t=l?.totalPages||1,a=[];if(t<=5)for(let i=1;i<=t;i++)a.push(i);else s<=3?a.push(1,2,3,4,"...",t):s>=t-2?a.push(1,"...",t-3,t-2,t-1,t):a.push(1,"...",s-1,s,s+1,"...",t);return a};return S.fetchAll==="loading"?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"})}):S.fetchAll==="failed"?e.jsxs("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4",role:"alert",children:[e.jsx("p",{className:"font-bold",children:"Error"}),e.jsx("p",{children:h})]}):e.jsx("div",{className:"bg-gray-50 min-h-screen p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-4",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between mb-6",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-4 md:mb-0",children:"Patient Test Records"})}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:space-x-4",children:[e.jsxs("div",{className:"relative grow mb-4 md:mb-0",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(V,{className:"text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Search by MR No, Name, Token # or Contact No",className:"pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",value:j,onChange:t=>T(t.target.value)})]}),e.jsxs("button",{onClick:()=>F(!g),className:"flex items-center px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:[e.jsx(X,{className:"mr-2"}),"Filters",g?e.jsx(Z,{className:"ml-2"}):e.jsx(ee,{className:"ml-2"})]})]}),g&&e.jsx("div",{className:"mt-4 p-4 bg-gray-50 rounded-md border border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{name:"status",value:d.status,onChange:_,className:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"All Statuses"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"paid",children:"Paid"}),e.jsx("option",{value:"partial",children:"Partial"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Gender"}),e.jsxs("select",{name:"gender",value:d.gender,onChange:_,className:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"All Genders"}),e.jsx("option",{value:"Male",children:"Male"}),e.jsx("option",{value:"Female",children:"Female"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Range"}),e.jsxs("select",{name:"dateRange",value:d.dateRange,onChange:_,className:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"All Dates"}),e.jsx("option",{value:"today",children:"Today"}),e.jsx("option",{value:"week",children:"This Week"}),e.jsx("option",{value:"month",children:"This Month"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contact No"}),e.jsx("input",{type:"text",name:"contact",value:d.contact,onChange:_,placeholder:"e.g. 0300-1234567",className:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:H,className:"px-4 py-2 text-sm text-gray-700 hover:text-gray-900",children:"Reset Filters"})})]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between mb-4 text-sm text-gray-600",children:[e.jsxs("div",{children:["Showing ",(s-1)*m+1," to"," ",Math.min(s*m,l?.totalItems||0)," of"," ",l?.totalItems||0," records"]}),e.jsx("div",{className:"flex items-center space-x-4 mt-2 md:mt-0",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{className:"mr-2 text-sm",children:"Rows per page:"}),e.jsxs("select",{value:m,onChange:q,className:"border border-gray-300 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:20,children:"20"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]})]})})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-20 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Token"}),e.jsx("th",{className:"w-28 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"MR No"}),e.jsx("th",{className:"w-40 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.jsx("div",{className:"truncate",children:"Patient Name"})}),e.jsx("th",{className:"w-36 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Contact No"}),e.jsx("th",{className:"w-20 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Age"}),e.jsx("th",{className:"w-64 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tests"}),e.jsx("th",{className:"w-36 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total Amount"}),e.jsx("th",{className:"w-40 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Remaining Amount"}),e.jsx("th",{className:"w-32 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"w-28 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"w-32 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:$.length>0?$.map(t=>{const a=t._norm;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"w-20 px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-center",children:a.tokenNumber}),e.jsx("td",{className:"w-28 px-3 py-4 whitespace-nowrap text-sm text-gray-500",children:e.jsx("div",{className:"truncate",children:a.patient.MRNo})}),e.jsx("td",{className:"w-40 px-3 py-4 text-sm text-gray-500",children:e.jsx("div",{className:"font-medium truncate",children:a.patient.Name})}),e.jsx("td",{className:"w-36 px-3 py-4 whitespace-nowrap text-sm text-gray-500 text-center",children:e.jsx("div",{className:"truncate",children:a.patient.Contact||a.patient.ContactNo})}),e.jsx("td",{className:"w-20 px-3 py-4 whitespace-nowrap text-sm text-gray-500 text-center",children:a.patient.Age}),e.jsx("td",{className:"w-64 px-3 py-4 text-sm text-gray-500",children:e.jsxs("div",{className:"space-y-1",children:[a.selectedTests.slice(0,2).map((i,p)=>e.jsxs("div",{className:"truncate",children:[e.jsx("span",{className:"font-medium",children:i._norm.testName}),i._norm.testCode&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["(",i._norm.testCode,")"]})]},p)),a.selectedTests.length>2&&e.jsxs("button",{onClick:()=>D(a),className:"text-primary-500 hover:underline text-sm mt-1",children:["See More (+",a.selectedTests.length-2,")"]})]})}),e.jsxs("td",{className:"w-36 px-3 py-4 text-sm text-right",children:[e.jsxs("div",{className:"font-medium",children:["Rs. ",a.totalAmount.toLocaleString()]}),a.totalDiscount>0&&e.jsxs("div",{className:"text-xs text-gray-400 truncate",children:["Discount: Rs. ",a.totalDiscount.toLocaleString()]})]}),e.jsxs("td",{className:"w-40 px-3 py-4 text-sm text-right",children:[e.jsxs("div",{className:"font-medium",children:["Rs. ",a.remainingAmount.toLocaleString()]}),a.totalPaid>0&&e.jsxs("div",{className:"text-xs text-gray-400 truncate",children:["Paid: Rs. ",a.totalPaid.toLocaleString()]})]}),e.jsx("td",{className:"w-32 px-3 py-4 whitespace-nowrap text-sm text-gray-500",children:a.createdAt?E(new Date(a.createdAt),"dd-MMM-yyyy"):""}),e.jsx("td",{className:"w-28 px-3 py-4 whitespace-nowrap text-center",children:e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-medium rounded-full 
                          ${a.paymentStatus==="paid"?"bg-green-100 text-green-800":a.paymentStatus==="pending"?"bg-yellow-100 text-yellow-800":a.paymentStatus==="partial"?"bg-primary-100 text-primary-800":"bg-red-100 text-red-800"}`,children:a.paymentStatus})}),e.jsx("td",{className:"w-32 px-3 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{onClick:()=>U(a),className:"text-green-600 hover:text-green-800",title:"Print",children:e.jsx(te,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>O(t._id),className:"text-primary-600 hover:text-primary-800",title:"Edit",children:e.jsx(se,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>z(t._id),className:"text-red-600 hover:text-red-800",title:"Delete",children:e.jsx(ae,{className:"h-4 w-4"})})]})})]},t._id||`${a.tokenNumber}-${a.createdAt}`)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"11",className:"px-6 py-4 text-center text-sm text-gray-500",children:"No records found matching your criteria"})})})]})}),(l?.totalPages||0)>1&&e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between mt-6 px-4 py-3 bg-white border-t border-gray-200",children:[e.jsxs("div",{className:"text-sm text-gray-700 mb-4 md:mb-0",children:["Page ",s," of ",l?.totalPages||1]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>A(1),disabled:s===1,className:`px-3 py-1 rounded border ${s===1?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-50"}`,children:"First"}),e.jsxs("button",{onClick:()=>A(s-1),disabled:s===1,className:`px-3 py-1 rounded border flex items-center ${s===1?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-50"}`,children:[e.jsx(re,{className:"mr-1"})," Previous"]}),e.jsx("div",{className:"flex space-x-1",children:Q().map((t,a)=>t==="..."?e.jsx("span",{className:"px-3 py-1",children:"..."},`ellipsis-${a}`):e.jsx("button",{onClick:()=>A(t),className:`px-3 py-1 rounded border ${s===t?"bg-primary-600 text-white border-primary-600":"text-gray-700 hover:bg-gray-50"}`,children:t},t))}),e.jsxs("button",{onClick:()=>A(s+1),disabled:s===(l?.totalPages||1),className:`px-3 py-1 rounded border flex items-center ${s===(l?.totalPages||1)?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-50"}`,children:["Next ",e.jsx(ne,{className:"ml-1"})]}),e.jsx("button",{onClick:()=>A(l?.totalPages||1),disabled:s===(l?.totalPages||1),className:`px-3 py-1 rounded border ${s===(l?.totalPages||1)?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-50"}`,children:"Last"})]})]}),N&&v&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full h-[80vh] overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"All Tests"}),e.jsx("div",{className:"mt-2 space-y-3",children:v.selectedTests.map((t,a)=>e.jsxs("div",{className:"border-b pb-2 last:border-0",children:[e.jsx("div",{className:"font-medium text-gray-900",children:t._norm.testName}),t._norm.testCode&&e.jsxs("div",{className:"text-sm text-gray-500",children:["Code: ",t._norm.testCode]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Price: Rs. ",t._norm.price.toLocaleString()," | Discount: Rs. ",t._norm.discount.toLocaleString()," | Paid: Rs. ",t._norm.paid.toLocaleString()]})]},a))}),e.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Total Tests: ",v.selectedTests.length]}),e.jsx("button",{onClick:M,className:"px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700",children:"Close"})]})]})})]})})};export{ge as default};
